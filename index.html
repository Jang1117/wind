<!DOCTYPE html>
<html>
<head>
  <title id="page-title">Korea Wind Power Plant Map by Seungho Jang</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" id="meta-description" content="한국 풍력 발전소의 위치, 제조사, 사업자, 단지, 준공일 정보를 제공하는 대화형 지도입니다. 신재생에너지와 친환경 에너지 데이터를 확인하세요.">
  <meta name="keywords" content="한국 풍력 발전소, 풍력단지 지도, 풍력 터빈, 제조사, 사업자, 준공일, Wind Farm, Wind Power Plant, Korea Wind Farm, Korea Wind Power Plant">
  <meta name="robots" content="index, follow">
  <!-- Kakao Maps SDK -->
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=KAKAO_APP_KEY&libraries=clusterer&autoload=false" defer></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    /* 기존 스타일 유지 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
      background: #f0f0f0;
      position: relative;
    }
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
    }
    #error-message {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    #controls {
      position: fixed;
      right: 10px;
      top: 10px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .control-button {
      width: 120px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      text-align: center;
      box-sizing: border-box;
      height: 34px;
      line-height: 1.5;
    }
    select.control-button {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    #settings-container {
      display: none;
      flex-direction: column;
      gap: 8px;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      right: 0;
      align-items: center;
    }
    #settings-container .control-button {
      width: 100px;
    }
    #settings-button {
      width: 120px;
    }
    #all-info, #manufacturer-info, #complex-info, #operator-info, #operation-period-info, #capacity-info {
      position: absolute;
      z-index: 10;
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      font-size: 14px;
      text-align: center;
      display: none;
      max-width: 90%;
    }
    @media screen and (min-width: 768px) {
      #all-info, #manufacturer-info, #complex-info, #operator-info, #operation-period-info, #capacity-info {
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
      }
    }
    @media (max-width: 767px) {
      #all-info, #manufacturer-info, #complex-info, #operator-info, #operation-period-info, #capacity-info {
        top: 10px;
        left: 10px;
        transform: none;
        text-align: nowrap;
        max-width: 80%;
      }
    }
    .info-window {
      background: rgba(255, 255, 255, 0.8);
      padding: 5px;
      border: 1px solid #ccc;
      font-size: 12px;
      pointer-events: auto;
    }
    .detail-window {
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      white-space: nowrap;
      max-width: 90vw;
      overflow: hidden;
      text-overflow: ellipsis;
      max-height: 80vh;
    }
    #info-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10001;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      font-size: 14px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      max-width: 300px;
      width: 90%;
    }
    #info-popup .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    #info-popup-content {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">지도 로딩 중...</div>
  <div id="error-message"></div>
  <div id="controls">
    <button id="initial-reset" class="control-button">처음으로</button>
    <button id="reset-button" class="control-button">선택 초기화</button>
    <select id="windfarm-dropdown" class="control-button">
      <option value="">풍력단지</option>
    </select>
    <select id="manufacturer-dropdown" class="control-button">
      <option value="">제조사</option>
    </select>
    <select id="operator-dropdown" class="control-button">
      <option value="">사업자</option>
    </select>
    <select id="operation-period-dropdown" class="control-button">
      <option value="">운영기간</option>
    </select>
    <select id="capacity-dropdown" class="control-button">
      <option value="">터빈 용량</option>
    </select>
    <button id="settings-button" class="control-button">설정/Setting</button>
    <div id="settings-container" style="display: none;">
      <button id="map-type-toggle" class="control-button">기본 지도</button>
      <button id="name-toggle-button" class="control-button">이름 켜기</button>
      <button id="marker-toggle-button" class="control-button">마커 끄기</button>
      <button id="translate-button" class="control-button">English</button>
      <button id="info-button" class="control-button">정보</button>
    </div>
  </div>
  <div id="all-info">
    <span id="info-all-capacity"></span><br>
    <span id="info-all-capacity-gw"></span><br>
    <span id="info-all-complex-count"></span><br>
    <span id="info-all-turbine-count"></span>
  </div>
  <div id="manufacturer-info">
    <span id="info-manufacturer"></span><br>
    <span id="info-total-capacity"></span><br>
    <span id="info-complex-count"></span><br>
    <span id="info-turbine-count"></span>
  </div>
  <div id="complex-info">
    <span id="info-complex-name"></span><br>
    <span id="info-complex-capacity"></span><br>
    <span id="info-complex-capacity-breakdown"></span><br>
    <span id="info-complex-manufacturers"></span><br>
    <span id="info-complex-turbine-count"></span><br>
    <span id="info-complex-completion"></span>
  </div>
  <div id="operator-info">
    <span id="info-operator"></span><br>
    <span id="info-operator-capacity"></span><br>
    <span id="info-operator-complex-count"></span><br>
    <span id="info-operator-turbine-count"></span>
  </div>
  <div id="operation-period-info">
    <span id="info-operation-period"></span><br>
    <span id="info-operation-capacity"></span><br>
    <span id="info-operation-complex-count"></span><br>
    <span id="info-operation-turbine-count"></span>
  </div>
  <div id="capacity-info">
    <span id="info-capacity-range"></span><br>
    <span id="info-capacity-total"></span><br>
    <span id="info-capacity-complex-count"></span><br>
    <span id="info-capacity-turbine-count"></span>
  </div>
  <div id="info-popup">
    <button class="close-button" onclick="toggleInfoPopup()">×</button>
    <div id="info-popup-content"></div>
  </div>
  <script>
    let map;
    let markers = [];
    let overlays = [];
    let currentInfowindows = [];
    let allWindFarms = [];
    let isSatellite = true;
    let turbineCountByComplex = {};
    let totalCapacityByComplex = {};
    let myLocationMarker = null;
    let watchId = null;
    let areNamesVisible = false;
    let areMarkersVisible = true;
    let selectedManufacturer = '';
    let selectedComplex = '';
    let selectedOperator = '';
    let selectedOperationPeriod = '';
    let selectedCapacityRange = '';
    let isEnglish = false;
    let translations = {};
    let siteTranslations = [];
    let manufacturerData = null;

    translations = {
      "ko": {
        // 기존 번역 유지
        "title": "한국 풍력 발전소 지도 by 장승호",
        "loading": "지도 로딩 중...",
        "mapTypeToggle": "기본 지도",
        "mapTypeToggleSatellite": "위성 지도",
        "nameToggle": "이름 끄기",
        "nameToggleOn": "이름 켜기",
        "markerToggle": "마커 끄기",
        "markerToggleOn": "마커 켜기",
        "reset": "선택 초기화",
        "translate": "English",
        "infoButton": "정보",
        "infoPopup": "제작자: 장승호<br>Email: 7911171g@gmail.com",
        "windfarmDropdown": "풍력단지",
        "manufacturerDropdown": "제조사",
        "operatorDropdown": "사업자",
        "operationPeriodDropdown": "운영기간",
        "capacityDropdown": "터빈 용량",
        "settings": "설정/Setting",
        "initialReset": "처음으로",
        "allInfo": {
          "totalCapacity": "총 용량: {{value}} kW",
          "totalCapacityGW": "총 용량: {{value}} GW",
          "complexCount": "단지 수: {{value}}",
          "turbineCount": "터빈 수: {{value}}"
        },
        "manufacturerInfo": {
          "manufacturer": "제조사: {{value}}",
          "totalCapacity": "총 용량: {{value}} kW",
          "complexCount": "단지 수: {{value}}",
          "turbineCount": "터빈 수: {{value}}"
        },
        "operatorInfo": {
          "operator": "사업자: {{value}}",
          "totalCapacity": "총 용량: {{value}} kW",
          "complexCount": "단지 수: {{value}}",
          "turbineCount": "터빈 수: {{value}}"
        },
        "complexInfo": {
          "name": "단지명: {{value}}",
          "capacity": "총 용량: {{value}} kW",
          "capacityBreakdown": "용량 분포: {{value}}",
          "manufacturers": "제조사: {{value}}",
          "turbineCount": "터빈 수: {{value}}",
          "completion": "준공일: {{value}}"
        },
        "operationPeriodInfo": {
          "operationPeriod": "운영기간: {{value}}",
          "totalCapacity": "총 용량: {{value}} kW",
          "complexCount": "단지 수: {{value}}",
          "turbineCount": "터빈 수: {{value}}"
        },
        "capacityInfo": {
          "capacityRange": "용량 범주: {{value}}",
          "totalCapacity": "총 용량: {{value}} kW",
          "complexCount": "단지 수: {{value}}",
          "turbineCount": "터빈 수: {{value}}"
        },
        "infoWindow": "{{name}} ({{count}}기)",
        "detailWindow": {
          "name": "단지명: {{value}}",
          "manufacturer": "터빈제조사: {{value}}",
          "capacity": "터빈용량: {{value}} kW",
          "turbineCount": "단지 터빈 수: {{value}}",
          "complexCapacity": "단지 총 용량: {{value}} kW",
          "capacityBreakdown": "용량 분포: {{value}}",
          "completion": "준공일: {{value}}",
          "address": "주소: {{value}}",
          "operator": "사업자: {{value}}"
        },
        "noInfo": "정보 없음",
        "errorMessage": {
          "csvLoad": "CSV 로드 실패: {{message}}",
          "csvParse": "CSV 파싱 실패: {{message}}",
          "geolocation": "위치 정보 가져오기 실패",
          "geolocationUnsupported": "위치 정보 지원 안 됨",
          "translationsLoad": "번역 데이터 로드 실패: {{message}}"
        },
        "myLocation": "내 위치",
        "operationPeriods": {
          "20plus": "20년 이상",
          "15to20": "15년 이상 ~ 20년 미만",
          "10to15": "10년 이상 ~ 15년 미만",
          "5to10": "5년 이상 ~ 10년 미만",
          "under5": "5년 미만"
        },
        "capacityRanges": {
          "under1mw": "1MW 미만",
          "1to2mw": "1MW 이상 ~ 2MW 미만",
          "2to3mw": "2MW 이상 ~ 3MW 미만",
          "3to5mw": "3MW 이상 ~ 5MW 미만",
          "5mwplus": "5MW 이상"
        }
      },
      "en": {
        // 기존 번역 유지
        "title": "South Korea Wind Farm Map by Seungho Jang",
        "loading": "Loading map...",
        "mapTypeToggle": "Road Map",
        "mapTypeToggleSatellite": "Satellite Map",
        "nameToggle": "Hide Name",
        "nameToggleOn": "Show Name",
        "markerToggle": "Hide Marker",
        "markerToggleOn": "Show Marker",
        "reset": "Select Reset",
        "translate": "한국어",
        "infoButton": "Info",
        "infoPopup": "Creator: Seungho Jang<br>Email: 7911171g@gmail.com",
        "windfarmDropdown": "Wind Farm",
        "manufacturerDropdown": "Manufacturer",
        "operatorDropdown": "Operator",
        "operationPeriodDropdown": "Operation Period",
        "capacityDropdown": "Turbine Capacity",
        "settings": "설정/Setting",
        "initialReset": "Home",
        "allInfo": {
          "totalCapacity": "Total Capacity: {{value}} kW",
          "totalCapacityGW": "Total Capacity: {{value}} GW",
          "complexCount": "Complexes: {{value}}",
          "turbineCount": "Turbines: {{value}}"
        },
        "manufacturerInfo": {
          "manufacturer": "Manufacturer: {{value}}",
          "totalCapacity": "Total Capacity: {{value}} kW",
          "complexCount": "Complexes: {{value}}",
          "turbineCount": "Turbines: {{value}}"
        },
        "operatorInfo": {
          "operator": "Operator: {{value}}",
          "totalCapacity": "Total Capacity: {{value}} kW",
          "complexCount": "Complexes: {{value}}",
          "turbineCount": "Turbines: {{value}}"
        },
        "complexInfo": {
          "name": "Complex: {{value}}",
          "capacity": "Total Capacity: {{value}} kW",
          "capacityBreakdown": "Capacity Breakdown: {{value}}",
          "manufacturers": "Manufacturers: {{value}}",
          "turbineCount": "Turbines: {{value}}",
          "completion": "Completion: {{value}}"
        },
        "operationPeriodInfo": {
          "operationPeriod": "Operation Period: {{value}}",
          "totalCapacity": "Total Capacity: {{value}} kW",
          "complexCount": "Complexes: {{value}}",
          "turbineCount": "Turbines: {{value}}"
        },
        "capacityInfo": {
          "capacityRange": "Capacity Range: {{value}}",
          "totalCapacity": "Total Capacity: {{value}} kW",
          "complexCount": "Complexes: {{value}}",
          "turbineCount": "Turbines: {{value}}"
        },
        "infoWindow": "{{name}} ({{count}} turbines)",
        "detailWindow": {
          "name": "Complex: {{value}}",
          "manufacturer": "Turbine Manufacturer: {{value}}",
          "capacity": "Turbine Capacity: {{value}} kW",
          "turbineCount": "Complex Turbines: {{value}}",
          "complexCapacity": "Complex Total Capacity: {{value}} kW",
          "capacityBreakdown": "Capacity Breakdown: {{value}}",
          "completion": "Completion: {{value}}",
          "address": "Address: {{value}}",
          "operator": "Operator: {{value}}"
        },
        "noInfo": "No Info",
        "errorMessage": {
          "csvLoad": "Failed to load CSV: {{message}}",
          "csvParse": "Failed to parse CSV: {{message}}",
          "geolocation": "Failed to get location",
          "geolocationUnsupported": "Geolocation not supported",
          "translationsLoad": "Failed to load translations: {{message}}"
        },
        "myLocation": "My Location",
        "operationPeriods": {
          "20plus": "20 years or more",
          "15to20": "15 to less than 20 years",
          "10to15": "10 to less than 15 years",
          "5to10": "5 to less than 10 years",
          "under5": "Less than 5 years"
        },
        "capacityRanges": {
          "under1mw": "Under 1MW",
          "1to2mw": "1MW to less than 2MW",
          "2to3mw": "2MW to less than 3MW",
          "3to5mw": "3MW to less than 5MW",
          "5mwplus": "5MW or more"
        }
      }
    };

    // 기존 loadManufacturers, loadTranslations, getTranslatedSiteInfo 함수 유지

    function resetToInitial() {
      selectedComplex = '';
      selectedManufacturer = '';
      selectedOperator = '';
      selectedOperationPeriod = '';
      selectedCapacityRange = '';
      areNamesVisible = false;
      document.getElementById('windfarm-dropdown').value = '';
      document.getElementById('manufacturer-dropdown').value = '';
      document.getElementById('operator-dropdown').value = '';
      document.getElementById('operation-period-dropdown').value = '';
      document.getElementById('capacity-dropdown').value = '';
      document.getElementById('name-toggle-button').textContent = translations[isEnglish ? 'en' : 'ko'].nameToggleOn;
      const allInfo = document.getElementById('all-info');
      const manufacturerInfo = document.getElementById('manufacturer-info');
      const complexInfo = document.getElementById('complex-info');
      const operatorInfo = document.getElementById('operator-info');
      const operationPeriodInfo = document.getElementById('operation-period-info');
      const capacityInfo = document.getElementById('capacity-info');
      allInfo.style.display = 'block';
      manufacturerInfo.style.display = 'none';
      complexInfo.style.display = 'none';
      operatorInfo.style.display = 'none';
      operationPeriodInfo.style.display = 'none';
      capacityInfo.style.display = 'none';
      map.setCenter(new kakao.maps.LatLng(35.68466926, 127.724382));
      map.setLevel(13);
      map.relayout();
      updateMarkers();
      updateInfoPanels();
    }

    function resetSelectionsOnly() {
      selectedComplex = '';
      selectedManufacturer = '';
      selectedOperator = '';
      selectedOperationPeriod = '';
      selectedCapacityRange = '';
      areNamesVisible = false;
      document.getElementById('windfarm-dropdown').value = '';
      document.getElementById('manufacturer-dropdown').value = '';
      document.getElementById('operator-dropdown').value = '';
      document.getElementById('operation-period-dropdown').value = '';
      document.getElementById('capacity-dropdown').value = '';
      document.getElementById('name-toggle-button').textContent = translations[isEnglish ? 'en' : 'ko'].nameToggleOn;
      const allInfo = document.getElementById('all-info');
      const manufacturerInfo = document.getElementById('manufacturer-info');
      const complexInfo = document.getElementById('complex-info');
      const operatorInfo = document.getElementById('operator-info');
      const operationPeriodInfo = document.getElementById('operation-period-info');
      const capacityInfo = document.getElementById('capacity-info');
      allInfo.style.display = 'none';
      manufacturerInfo.style.display = 'none';
      complexInfo.style.display = 'none';
      operatorInfo.style.display = 'none';
      operationPeriodInfo.style.display = 'none';
      capacityInfo.style.display = 'none';
      updateInfoPanels();
      updateMarkers();
    }

    function updateUILanguage() {
      const lang = isEnglish ? 'en' : 'ko';
      document.getElementById('page-title').textContent = translations[lang].title;
      document.getElementById('loading').textContent = translations[lang].loading;
      document.getElementById('map-type-toggle').textContent = isSatellite ? translations[lang].mapTypeToggle : translations[lang].mapTypeToggleSatellite;
      document.getElementById('name-toggle-button').textContent = areNamesVisible ? translations[lang].nameToggle : translations[lang].nameToggleOn;
      document.getElementById('marker-toggle-button').textContent = areMarkersVisible ? translations[lang].markerToggle : translations[lang].markerToggleOn;
      document.getElementById('translate-button').textContent = translations[lang].translate;
      document.getElementById('info-button').textContent = translations[lang].infoButton;
      document.getElementById('reset-button').textContent = translations[lang].reset;
      document.getElementById('settings-button').textContent = translations[lang].settings;
      document.getElementById('initial-reset').textContent = translations[lang].initialReset;
      document.getElementById('windfarm-dropdown').options[0].textContent = translations[lang].windfarmDropdown;
      document.getElementById('manufacturer-dropdown').options[0].textContent = translations[lang].value;
      document.getElementById('operator-info').options[0].operatorDropdown;
      document.getElementById('operation-period-dropdown').options[0].operationPeriod = translations[lang].operationPeriodDropdown';
      document.getElementById('capacity-dropdown').options[0].textContent = translations[lang].capacityDropdown;
      const windfarmDropdown = document.getElementById('windfarm-winddrop');
      const selectedValue = windfarmDropdown.value;
      while (windfarmDropdown.options.length > 1) windfarmDropdown.remove(1);
      populateDropdown();
      windfarmDropdown.value = selectedValue;
      const manufacturerDropdown = document.getElementById('manufacturer-dropdown');
      const selectedManufacturer = manufacturerDropdown.value;
      const while (manufacturerDropdown.options.length > 1) manufacturerDropdown.remove(1);
      populateManufacturerDropdown();
      manufacturerDropdown.value = selectedManufacturer;
      const operatorDropdown = document.getElementById('operator-dropdown');
      const selectedOperatorValue = operatorDropdown.value;
      while (operatorDropdown.options.length > 1) operatorDropdown.remove(1);
      populateOperatorDropdown();
      operatorDropdown.value = selectedOperatorValue;
      const capacityDropdown = document.getElementById('capacity-dropdown');
      const selectedCapacityValue = capacityDropdown.value;
      while (capacityDropdown.options.length > 1) capacityDropdown.remove(1);
      populateCapacityDropdown();
      capacityDropdown.value = selectedCapacityValue;
      updateInfoPanels();
      updateTheMarkers();
    }

    // 기존 showError, toggleLanguage, showInfoPopup, formatNumberWith,Commas, formatGW, calculateAge, getOperationPeriod, loadCSVData, initializeApp 함수 유지

    function initMap() {
      console.log("initMap 호출됨");
      const container = document.getElementById('map');
      const options = {
        center: new kakao.Map.centerLatLng(35.68466926, 127.724382),
        level: 13
      };
      map = new kakao.maps.Map(container, options);
      map.setMapTypeId(kakao.MapTypeId.HYBRID);
      console.log("지도 생성됨:", map);
      setTimeout(() => {
        map.relayout();
        document.getElementById('all-info').style.display = 'block';
        updateInfoPanels();
        console.log("지도 렌더링 완료");
        updateMarkers();
        startTrackingLocation();
      }, 100);
      kakao.maps.event.addListener(map, 'click', () => {
        currentInfowindow.forEach(infowindow);
 infowindow.setMap(null));
        currentInfowindows = [];
      });
      kakao.event.addListener('zoom_changed', updateMarkers);
      kakao.event.addListener('idle', updateMarkers);
      document.getElementById('loading').style.display-id='none';
      document.getElementById('initial-reset').addEventListener('click', resetToInitial);
      document.getElementById('reset-button').addEventListener('click', resetSelectionsOnly);
      document.getElementById('map-type-toggle').addEventListener('click', toggleMapType);
      document.getElementById('name-toggle').click', toggleNameVisibility);
      document.getElementById('marker-toggle').addEventListener('click', toggleMarkerVisibility);
      document.getElementById('translate-button').addEventListener('click', toggleLanguage);
      document.getElementById('info-button').addEvent('click', toggleInfoPopup);
      document.getElementById('settings-button').addEventListener('click', () => {
        const settingsContainer = document.getElementById('settings');
        settingsContainer.style.display = settingsContainer.style.display === 'none' ? 'flex' : 'none';
        console.log("설정 컨테이너 표시 상태:", settingsContainer.style.display);
      });
      document.getElementById('windfarm-dropdown').addEventListener('change', handleDropdownChange);
      document.getElementById('manufacturer-dropdown').addEventListener('change', handleManufacturerChange);
      document.getElementById('operator-dropdown').addEventListener('change', handleOperatorChange);
      document.getElementById('operation-period-dropdown').addEventListener('change', handleOperationPeriodChange);
      document.getElementById('capacity-dropdown').addEventListener('change', handleCapacityChange);
      document.getElementById('info-popup').addEventListener('click', (e) => {
        if (e.target === document.getElementById('info-popup')) {
          toggleInfoPopup();
        }
      });
    }

    // 기존 toggleMapType, toggleNamesVisibility, toggleMarkersVisibility, populateDropdown, populateManufacturer, populateOperatorDropdown, populateOperationPeriodDropdown, handleDropdownChange, handleManufacturerChange, handleOperatorChange, handleOperationPeriodChange 함수 유지

    function getCapacityRange(capacity) {
      if (!capacity) return null;
      const mw = capacity / 1000;
      if (mw < 1) return 'under1mw';
      if (mw < 2) return '1to2mw';
      if (mw < 3) return '2to3mw';
      if (mw < 5) return '3to5mw';
      return '5mwplus';
    }

    function populateCapacityDropdown() {
      const dropdown = document.getElementById('capacity-dropdown');
      while (dropdown.options.length > 1) dropdown.remove(1);
      const capacityRanges = [
        { id: 'under1mw', label: translations[isEnglish ? 'en' : 'ko'].capacityRanges.under1mw },
        { id: '1to2mw', label: translations[isEnglish ? 'en' : 'ko'].capacityRanges.1to2mw },
        { id: '2to3mw', label: translations[isEnglish ? 'en' : 'ko'].capacityRanges.2to3mw },
        { id: '3to5mw', label: translations[isEnglish ? 'en' : 'ko'].capacityRanges.3to5mw },
        { id: '5mwplus', label: translations[isEnglish ? 'en' : 'ko'].capacityRanges.5mwplus }
      ];
      capacityRanges.forEach(range => {
        const option = document.createElement('option');
        option.value = range.id;
        option.textContent = range.label;
        dropdown.appendChild(option);
      });
    }

    function handleCapacityChange(event) {
      selectedCapacityRange = event.target.value;
      selectedComplex = '';
      selectedManufacturer = '';
      selectedOperator = '';
      selectedOperationPeriod = '';
      areNamesVisible = true;
      document.getElementById('windfarm-dropdown').value = '';
      document.getElementById('manufacturer-dropdown').value = '';
      document.getElementById('operator-dropdown').value = '';
      document.getElementById('operation-period').value = '';
      document.getElementById('name-toggle-button').textContent = translations[isEnglish ? 'en' : 'ko'].nameToggle;
      const allInfo = document.getElementById('info-all');
      const manufacturerInfo = document.getElementById('manufacturer-info');
      const complexInfo = document.getElementById('complex-info');
      const operatorInfo = document.getElementById('operator-info');
      const operationPeriodInfo = document.getElementById('operation-period-info');
      const capacityInfo = allInfo.getElementById('capacity-info');
      allInfo.filterInfo.display = 'none';
      manufacturerInfo.style.display = 'none';
      complexInfo.style.display = 'none';
      operatorInfo.style.display = 'none';
      operationPeriodInfo.style.display = 'none';
      let filteredFarms = allWindFarms;
      if (selectedCapacityRange) {
        filteredFarms = allWindFarms.filter(farm => getCapacityRange(farm.capacity) === selectedCapacityRange);
        const totalCapacity = filteredFarms.reduce((sum, farm) => sum + (farm.capacity || 0), 0);
        const complexCount = [...new Set(filteredFarms.map(farm => farm.complexId))].length;
        const turbineCount = filteredFarms.length;
        const lang = isEnglish ? 'en' : 'ko';
        const rangeLabel = translations[lang].capacityRanges[selectedCapacityRange];
        document.getElementById('info-total').innerHTML = translations[lang].capacityInfo.totalCapacityRange.replace('{{totalCapacity}}', rangeLabel);
        document.getElementById('info-total-capacity').innerHTML = translations[lang].capacityInfo.totalCapacity.replace('{{value}}', formatNumberWith(totalCapacity));
        document.getElementById('info-capacity-complex-count').innerHTML = translations[lang].capacityInfo.complexCount.replace('{{value}}', complexCount);
        document.getElementById('info-total-turbine-count').innerHTML = translations[lang].capacityInfo.turbineCount.replace('{{value}}', turbineCount);
        capacityInfo.style.display = 'block';
      } else {
        capacityInfo.filter.display = 'none';
        allInfo.style.display = 'block';
        updateInfo();
      }
      if (filteredFarms.length === 0) {
        map.setFiltered();
        map.setCenter(new kakao.maps.LatLng(35.68466926, 127.724382));
        map.setLevel(13);
      } else if (filteredFarms.length === 1) {
        const farm = filteredFarms[0];
        map.setCenter(new kakao.Map.LatLng(farm.lat, farm.lon));
        map.setLevel(6);
      } else {
        const bounds = new kakao.maps.LatLngBounds();
        filteredFarms.forEach(farm => {
          if (farm.lat && farm.lon) {
            bounds.extend(new kakao.LatLng(farm.lat, farm.lon));
          );
        });
        map.setBounds(bounds);
      }
      updateMarkers();
    }

    function updateInfoPanels() {
      const lang = isEnglish ? 'en' : 'ko';
      if (allWindFarms.length > 0) {
        const totalCapacity = allWindFarms.reduce((sum, farm) => sum + (farm.capacity || 0), 0);
        const complexCount = [...new Set(allWindFarms.map(farm => farm.complexId))].length;
        const turbineCount = allWindFarms.length;
        document.getElementById('info-all-capacity').innerHTML = translations[lang].allInfo.totalCapacity.replace('{{value}}', formatNumberWith(totalCapacity));
        document.getElementById('info-all-capacity-gw').innerHTML = translations[lang].allInfo.totalCapacityGW.replace('{{value}}', formatGW(totalCapacity));
        document.getElementById('info-all-complex-count').innerHTML = translations[lang].allInfo.complexCount.replace('{{value}}', complexCount);
        document.getElementById('info-all-turbine-count').innerHTML = translations[lang].allInfo.turbineCount.replace('{value}}', turbineCount);
      }
      if (selectedManufacturer && document.getElementById('manufacturer-info').style.display === 'block') {
        const filteredFarms = allWindFarms.filter(farm => farm.manufacturer === selectedManufacturer);
        const totalCapacity = filteredFarms.reduce((sum, farm) => sum + (farm.capacity || 0), 0);
        const complexCount = [...new Set(filteredFarms.map(farm => farm.complexId))].length;
        const turbineCount = filteredFarms.length;
        document.getElementById('info-manufacturer').innerHTML = translations[lang].manufacturerInfo.manufacturer.replace('{{value}}', selectedManufacturer);
        document.getElementById('info-total-capacity').innerHTML = translations[lang].manufacturerInfo.totalCapacity.replace('{{value}}', formatNumberWith(totalCapacity));
        document.getElementById('info-complex-count').innerHTML = translations[lang].manufacturerInfo.complexCount.replace('{{value}}', complexCount);
        document.getElementById('info-turbine-count').innerHTML = translations[lang].manufacturerInfo.turbineCount.replace('{{value}}', turbineCount);
      }
      if (selectedOperator && document.getElementById('operator-info').style.display === 'block') {
        const filteredFarms = allWindFarms.filter(farm => farm.operator === selectedOperator);
        const totalCapacity = filteredFarms.reduce((sum, farm) => sum + (farm.capacity || 0));
        const complexCount = [...new Set(filteredFarms.map(farm => farm.complexId))].length;
        const turbineCount = filteredFarms.length;
        document.getElementById('info-operator').innerHTML = translations[lang].operatorInfo.operator.replace('{{value}}', selectedOperator);
        document.getElementById('info-operator-capacity').innerHTML = translations[lang].operatorInfo.totalCapacity.replace('{{value}}', formatNumberWith(totalCapacity));
        document.getElementById('info-operator-complex-count').innerHTML = translations[lang].operatorInfo.complexCount.replace('{{value}}', complexCount);
        document.getElementById('info-operator-turbine-count').innerHTML = translations[lang].operatorInfo.turbineCount.replace('{{value}}', turbineCount);
      }
      if (selectedComplex && document.getElementById('complex-info').style.display === 'block') {
        const farmsInComplex = allWindFarms.filter(farm => farm.complexId === selectedComplex);
        updateComplexInfo(farmsInComplex);
      }
      if (selectedOperationPeriod && document.getElementById('operation-period').style.display === 'block') {
        const filteredFarms = allWindFarms.filter(farm => getOperationPeriod(farm.age) === selectedOperationPeriod);
        const totalCapacity = filteredFarms.reduce((sum, farm) => sum + (farm.capacity || 0));
        const complexCount = [...new Set(farms.map(farm => farm.complexId))].length;
        const turbineCount = filteredFarms.length;
        const periodLabel = translations[lang].operationPeriods[selectedOperationPeriod];
        document.getElementById('info-period-period').innerHTML = translations[lang].operationPeriodInfo.operationPeriod.replace('{{periodLabel}}', periodLabel);
        document.getElementById('info-operation-capacity').innerHTML = translations[lang].operationPeriodInfo.totalCapacity.replace('{{value}}', formatNumberWith(totalCapacity));
        document.getElementById('info-operation-complex-count').innerHTML = translations[lang].operationPeriodInfo.complexCount.replace('{{value}}', complexCount);
        document.getElementById('info-period-turbine-count').innerHTML = translations[lang].operationPeriodInfo.turbineCount.replace('{{value}}', turbineCount);
      }
      if (selectedCapacityRange && document.getElementById('capacity-info').style.display === 'block') {
        const filteredFarms = allWindFarms.filter(farm => getCapacityRange(farm.capacity) === selectedCapacityRange);
        const totalCapacity = filteredFarms.reduce((sum, farm) => sum + (farm.capacity || 0));
        const complexCount = [...new Set(farms.map(farm => farm.complexId))].length;
        const turbineCount = filteredFarms.length;
        const rangeLabel = translations[lang].capacityRanges[selectedCapacityRange];
        document.getElementById('info-total').innerHTML = translations[lang].capacityInfo.totalCapacityRange.replace('{{value}}');, rangeLabel);
        document.getElementById('info-total-capacity').innerHTML = translations[lang].capacityInfo.totalCapacity.replace('{{value}}', formatNumberWith(totalCapacity));
        document.getElementById('info-count').innerHTML = translations[lang].capacityInfo.complexCount.replace('{{{value}}', complexCount);
        document.getElementById('info-turbine-count').innerHTML = translations[lang].capacityInfo.turbineCount.replace('{{{value}}', turbineCount);
      }
    }

    // 기존 startTrackingLocation, updateMyLocation, clearMap 함수 유지

    function updateMarkers() {
      clearMap();
      const zoomLevel = map.getLevel();
      console.log("현재 줌 레벨:", zoomLevel);
      const markerImage = new kakao.MarkerImage(
        '/wind/marker.png',
        new kakao.Size(48, 48),
        { offset: new kakaoPoint(16, 32) }
      );
      let filteredFarms = allWindFarms;
      if (selectedCapacityRange) {
        filteredFarms = allWindFarms.filter(farm => getCapacityRange(farm.capacity) === selectedCapacityRange);
      } else if (selectedOperationPeriod) {
        filteredFarms = filteredFarms.filter(farm => getOperationPeriod(farm.age) === selectedOperationPeriod);
      } else if (selectedOperator) {
        filteredFarms = allWindFarms.filter(farm => farm.operator === selectedOperator);
      } else if (selectedManufacturer) {
        filteredFarms = allWindFarms.filter(farm => farm.manufacturer === selectedManufacturer);
      } else if (selectedComplex) {
        filteredFarms = allWindFarms.filter(farm => farm.complexId === selectedComplex);
      }
      filteredFarms = filteredFarms.filter(farm => farm.age !== null);
      console.log("필터링된 터빈 수:", filteredFarms.length);
      const lang = isEnglish ? 'en' : 'ko';
      const farmsByComplex = {};
      filteredFarms.forEach(farm => {
        if (!farmsByComplex[farm.complexId]) farmsByComplex[farm.complexId] = [];
        farmsByComplex[farm.complexId].push(farm);
      });
      Object.keys(farmsByComplex).forEach(complexId => {
        const group = farmsByComplex[complexId];
        const avgLat = group.reduce((sum, farm) => sum + farm.lat, 0) / group.length;
        const avgLon = group.reduce((sum, farm) => sum + farm.lon, 0) / group.length;
        const position = new kakao.LatLng(avgLat, avgLon);
        const complexName = getTranslatedSiteInfo(complexId, 'name') || group[0].name;
        let marker = null;
        if (areMarkersVisible) {
          marker = new kakao.Marker({
            position: position,
            title: `${complexName} (${group.length}${isEnglish ? ' turbines' : '개 터빈'})`,
            clickable: true,
            image: markerImage
          });
          marker.setMap(map);
          markers.push(marker);
        }
        if (areNamesVisible) {
          const overlay = new kakao.maps.CustomOverlay({
            position: position,
            content: `<div class="info-window">${translations[lang].infoWindow.replace('{{name}}', complexName).replace('{{count}}', group.length)}}</div>`,
            xAnchor: 0.5,
            yAnchor: 2,
            zIndex: 10
          });
          overlay.setMap(map);
          overlays.push(...overlay);
        }
        if (areMarkersVisible && marker) {
          kakao.event.addListener(marker, 'click', () => {
            selectedComplex = complexId;
            selectedManufacturer = '';
            selectedOperator = '';
            selectedOperationPeriod = '';
            selectedCapacityRange = '';
            areNamesVisible = true;
            document.getElementById('manufacturer-dropdown').value = '';
            document.getElementById('operator-id').value = '';
            document.getElementById('operation-period').value = '';
            document.getElementById('capacity-dropdown').value = '';
            document.getElementById('windfarm-dropdown').value = complexId;
            document.getElementById('name-toggle').textContent = translations[lang].nameToggle;
            const allInfo = document.getElementById('info-all-info');
            const manufacturerInfo = document.getElementById('manufacturer-info');
            const complexInfo = document.getElementById('complex-info');
            const operatorInfo = document.getElementById('operator-info');
            const operationPeriodInfo = document.getElementById('operation-period-info');
            const capacityInfo = document.getElementById('capacity-info');
            allInfo.style.display = 'none';
            manufacturerInfo.style.display = 'none';
            operatorInfo.style.display = 'none';
            operationPeriodInfo.style.display = 'none';
            capacityInfo.style.display = 'none';
            updateComplexInfo(group);
            complexInfo.style.display = 'block';
            map.setCenter(position);
            const currentLevel = map.getLevel();
            map.setLevel(currentLevel - 5);
            updateMarkers();
          });
        }
      });
      if (myLocationMarker) {
        myLocationMarker.setMap(map);
        marker.push(myLocationMarker);
      }
    }

    // 기존 toggleFarmDetails, closeInfowindow 함수 유지

    document.addEventListener('DOMContentLoaded', function() {
      kakao.maps.load(() => {
        console.log("Kakao Maps API 로드 성공");
        initializeApp();
      });
    });

    window.addEventListener('unload', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        console.log("위치 추적 중지");
      }
    });
  </script>
</body>
</html>
