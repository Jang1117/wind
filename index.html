<!DOCTYPE html>
<html>
<head>
    <title>Korea Wind Power Plant Map (24.08.16) by Seungho Jang</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9b8113591f35c3409335bdb4b5ee5613&libraries=clusterer&autoload=false" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            position: relative;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
        }
        #map-type-toggle, #name-toggle-button, #language-toggle-button {
            position: absolute;
            right: 10px;
            z-index: 10;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            cursor: pointer;
        }
        #map-type-toggle {
            top: 10px;
        }
        #name-toggle-button {
            top: 40px;
        }
        #language-toggle-button {
            top: 70px;
        }
        .info-window {
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border: 1px solid #ccc;
            font-size: 12px;
            pointer-events: auto;
        }
        .detail-window {
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">지도 로딩 중...</div>
    <div id="error-message"></div>
    <button id="map-type-toggle">기본 지도</button>
    <button id="name-toggle-button">터빈 이름 끄기</button>
    <button id="language-toggle-button">English</button>

    <script>
        let map;
        let markers = [];
        let overlays = [];
        let currentInfowindows = [];
        let allWindFarms = [];
        let isSatellite = true;
        let turbineCountByComplex = {};
        let myLocationMarker = null;
        let watchId = null;
        let areNamesVisible = true;
        let currentLanguage = 'ko'; // Default language is Korean
        
        // Language-specific text
        const translations = {
            ko: {
                loading: "지도 로딩 중...",
                mapTypeBase: "기본 지도",
                mapTypeSatellite: "위성 지도",
                turbineNameHide: "터빈 이름 끄기",
                turbineNameShow: "터빈 이름 켜기",
                myLocation: "내 위치",
                turbines: "개 터빈",
                manufacturer: "터빈 제조사",
                singleCapacity: "단일 터빈 용량(kW)",
                totalTurbines: "단지 내 총 터빈 수",
                totalCapacity: "단지 총 용량(kW)",
                completionDate: "준공일",
                address: "주소",
                noInfo: "정보 없음",
                languageToggle: "English"
            },
            en: {
                loading: "Loading map...",
                mapTypeBase: "Basic Map",
                mapTypeSatellite: "Satellite Map",
                turbineNameHide: "Hide Turbine Names",
                turbineNameShow: "Show Turbine Names",
                myLocation: "My Location",
                turbines: " turbines",
                manufacturer: "Turbine Manufacturer",
                singleCapacity: "Single Turbine Capacity(kW)",
                totalTurbines: "Total Turbines in Complex",
                totalCapacity: "Total Complex Capacity(kW)",
                completionDate: "Completion Date",
                address: "Address",
                noInfo: "No information",
                languageToggle: "한국어"
            }
        };

        function formatNumberWithCommas(number) {
            if (!number) return translations[currentLanguage].noInfo;
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        async function loadCSVData() {
            try {
                // Choose the correct CSV file based on current language
                const csvFile = currentLanguage === 'ko' ? 'windfarm_data.csv' : 'windfarm_data_en.csv';
                const response = await fetch(csvFile);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log("CSV data:", text);

                // Reset turbine count when loading new data
                turbineCountByComplex = {};
                
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Map field names based on language
                        allWindFarms = results.data.map(row => {
                            // Use different field names based on language
                            const nameField = currentLanguage === 'ko' ? '단지명' : 'Complex Name';
                            const complexIdField = currentLanguage === 'ko' ? '단지번호' : 'Complex ID';
                            const turbineIdField = currentLanguage === 'ko' ? '풍력기번호(임시)' : 'Turbine ID';
                            const completionDateField = currentLanguage === 'ko' ? '준공일' : 'Completion Date';
                            const typeField = currentLanguage === 'ko' ? '분류' : 'Type';
                            const addressField = currentLanguage === 'ko' ? '주소' : 'Address';
                            const xCoordField = currentLanguage === 'ko' ? '엑스좌표(GRS80_C_x)' : 'X Coordinate';
                            const yCoordField = currentLanguage === 'ko' ? '와이좌표(GRS80_C_y)' : 'Y Coordinate';
                            const latField = currentLanguage === 'ko' ? '위도(lat)' : 'Latitude';
                            const lonField = currentLanguage === 'ko' ? '경도(lon)' : 'Longitude';
                            const capacityField = currentLanguage === 'ko' ? '용량(kW)' : 'Capacity(kW)';
                            const manufacturerField = currentLanguage === 'ko' ? '제조사' : 'Manufacturer';
                            
                            const name = row[nameField] ? row[nameField].trim() : null;
                            if (!name) return null;
                            
                            return {
                                complexId: row[complexIdField] ? row[complexIdField].trim() : null,
                                name: name,
                                turbineId: row[turbineIdField] ? row[turbineIdField].trim() : null,
                                completionDate: row[completionDateField] ? row[completionDateField].trim() : null,
                                type: row[typeField] ? row[typeField].trim() : null,
                                address: row[addressField] ? row[addressField].trim() : null,
                                xCoord: row[xCoordField] ? parseFloat(row[xCoordField]) : null,
                                yCoord: row[yCoordField] ? parseFloat(row[yCoordField]) : null,
                                lat: row[latField] ? parseFloat(row[latField]) : null,
                                lon: row[lonField] ? parseFloat(row[lonField]) : null,
                                capacity: row[capacityField] ? parseFloat(row[capacityField]) : null,
                                manufacturer: row[manufacturerField] ? row[manufacturerField].trim() : null
                            };
                        }).filter(row => row !== null);
                        console.log("Parsed data:", allWindFarms);

                        allWindFarms.forEach(farm => {
                            if (!turbineCountByComplex[farm.name]) {
                                turbineCountByComplex[farm.name] = 0;
                            }
                            turbineCountByComplex[farm.name]++;
                        });
                        console.log("Turbine count by complex:", turbineCountByComplex);

                        if (map) {
                            updateMarkers();
                        } else {
                            initMap();
                        }
                    },
                    error: function(error) {
                        console.error('CSV parsing failed:', error);
                        document.getElementById('error-message').innerText = `CSV parsing failed: ${error.message}`;
                    }
                });
            } catch (error) {
                console.error('CSV loading failed:', error);
                document.getElementById('error-message').innerText = `Cannot load data: ${error.message}`;
            }
        }

        function initMap() {
            console.log("initMap called");
            const container = document.getElementById('map');
            console.log("Container:", container);
            const options = {
                center: new kakao.maps.LatLng(36.41119125, 129.4146661),
                level: 13
            };
            map = new kakao.maps.Map(container, options);
            map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
            console.log("Map created:", map);

            setTimeout(() => {
                map.relayout();
                map.setCenter(new kakao.maps.LatLng(36.41119125, 129.4146661));
                console.log("Map rendering complete");
                updateMarkers();
                startTrackingLocation();
            }, 100);

            kakao.maps.event.addListener(map, 'click', () => {
                currentInfowindows.forEach(infowindow => infowindow.setMap(null));
                currentInfowindows = [];
            });

            kakao.maps.event.addListener(map, 'zoom_changed', updateMarkers);
            kakao.maps.event.addListener(map, 'idle', updateMarkers);

            document.getElementById('loading').style.display = 'none';

            const toggleButton = document.getElementById('map-type-toggle');
            toggleButton.addEventListener('click', toggleMapType);

            const nameToggleButton = document.getElementById('name-toggle-button');
            nameToggleButton.addEventListener('click', toggleNamesVisibility);
            
            const languageToggleButton = document.getElementById('language-toggle-button');
            languageToggleButton.addEventListener('click', toggleLanguage);
            
            // Update UI language
            updateUILanguage();
        }
        
        function updateUILanguage() {
            document.getElementById('loading').innerText = translations[currentLanguage].loading;
            document.getElementById('map-type-toggle').innerText = isSatellite ? 
                translations[currentLanguage].mapTypeBase : 
                translations[currentLanguage].mapTypeSatellite;
            document.getElementById('name-toggle-button').innerText = areNamesVisible ? 
                translations[currentLanguage].turbineNameHide : 
                translations[currentLanguage].turbineNameShow;
            document.getElementById('language-toggle-button').innerText = 
                translations[currentLanguage].languageToggle;
        }

        function toggleMapType() {
            if (isSatellite) {
                map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
                document.getElementById('map-type-toggle').textContent = translations[currentLanguage].mapTypeSatellite;
                isSatellite = false;
            } else {
                map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
                document.getElementById('map-type-toggle').textContent = translations[currentLanguage].mapTypeBase;
                isSatellite = true;
            }
            console.log("Map type changed:", isSatellite ? "satellite" : "basic");
        }

        function toggleNamesVisibility() {
            areNamesVisible = !areNamesVisible;
            document.getElementById('name-toggle-button').textContent = areNamesVisible ? 
                translations[currentLanguage].turbineNameHide : 
                translations[currentLanguage].turbineNameShow;
            updateMarkers(); // Re-render markers and overlays to reflect name visibility
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ko' ? 'en' : 'ko';
            console.log("Language switched to:", currentLanguage);
            updateUILanguage();
            loadCSVData(); // Reload data with new language
        }

        function startTrackingLocation() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        console.log("My location updated:", lat, lon);
                        updateMyLocation(lat, lon);
                    },
                    error => {
                        console.error("Failed to get location:", error);
                        document.getElementById('error-message').innerText = "Unable to get location information.";
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error("Geolocation not supported");
                document.getElementById('error-message').innerText = "Browser does not support Geolocation.";
            }
        }

        function updateMyLocation(lat, lon) {
            const position = new kakao.maps.LatLng(lat, lon);

            if (myLocationMarker) {
                myLocationMarker.setMap(null);
            }

            myLocationMarker = new kakao.maps.Marker({
                position: position,
                title: translations[currentLanguage].myLocation,
                clickable: false,
                image: new kakao.maps.MarkerImage(
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                    new kakao.maps.Size(24, 35)
                )
            });
            myLocationMarker.setMap(map);
            markers.push(myLocationMarker);
        }

        function clearMap() {
            markers.forEach(marker => marker.setMap(null));
            overlays.forEach(overlay => overlay.setMap(null));
            markers = [];
            overlays = [];
            currentInfowindows.forEach(infowindow => infowindow.setMap(null));
            currentInfowindows = [];
        }

        function updateMarkers() {
            clearMap();
            const zoomLevel = map.getLevel();
            console.log("Current zoom level:", zoomLevel);

            if (zoomLevel >= 10) {
                const farmsByComplex = {};
                allWindFarms.forEach(farm => {
                    if (!farmsByComplex[farm.name]) farmsByComplex[farm.name] = [];
                    farmsByComplex[farm.name].push(farm);
                });

                Object.keys(farmsByComplex).forEach(complex => {
                    const group = farmsByComplex[complex];
                    const avgLat = group.reduce((sum, farm) => sum + farm.lat, 0) / group.length;
                    const avgLon = group.reduce((sum, farm) => sum + farm.lon, 0) / group.length;
                    const position = new kakao.maps.LatLng(avgLat, avgLon);

                    const marker = new kakao.maps.Marker({
                        position: position,
                        title: `${complex} (${group.length}${translations[currentLanguage].turbines})`,
                        clickable: true
                    });
                    marker.setMap(map);
                    markers.push(marker);

                    if (areNamesVisible) {
                        const overlay = new kakao.maps.CustomOverlay({
                            position: position,
                            content: `<div class="info-window">${complex} (${group.length})</div>`,
                            xAnchor: 0.5,
                            yAnchor: 2,
                            zIndex: 10
                        });
                        overlay.setMap(map);
                        overlays.push(overlay);
                    }

                    kakao.maps.event.addListener(marker, 'click', () => {
                        map.setCenter(position);
                        map.setLevel(9);
                    });
                });
            } else {
                const bounds = map.getBounds();
                const visibleFarms = allWindFarms.filter(farm => 
                    farm.lat && farm.lon && bounds.contain(new kakao.maps.LatLng(farm.lat, farm.lon))
                );
                console.log("Number of turbines to display:", visibleFarms.length);

                visibleFarms.forEach(farm => {
                    const position = new kakao.maps.LatLng(farm.lat, farm.lon);
                    const turbineName = `${farm.name} ${farm.turbineId}`;
                    const marker = new kakao.maps.Marker({
                        position: position,
                        title: turbineName,
                        clickable: true
                    });
                    marker.setMap(map);
                    markers.push(marker);

                    if (areNamesVisible) {
                        const overlay = new kakao.maps.CustomOverlay({
                            position: position,
                            content: `<div class="info-window" onclick="toggleFarmDetails('${farm.name}', '${farm.turbineId}', '${farm.type}', '${farm.completionDate}', '${farm.address}', ${farm.lat}, ${farm.lon}, '${farm.capacity}', '${farm.manufacturer}')">${turbineName}</div>`,
                            xAnchor: 0.5,
                            yAnchor: 2,
                            zIndex: 10
                        });
                        overlay.setMap(map);
                        overlays.push(overlay);
                    }

                    kakao.maps.event.addListener(marker, 'click', () => toggleFarmDetails(farm.name, farm.turbineId, farm.type, farm.completionDate, farm.address, farm.lat, farm.lon, farm.capacity, farm.manufacturer));
                });
            }

            if (myLocationMarker) {
                myLocationMarker.setMap(map);
                markers.push(myLocationMarker);
            }
        }

        window.toggleFarmDetails = function(name, turbineId, type, completionDate, address, lat, lon, capacity, manufacturer) {
            currentInfowindows.forEach(infowindow => infowindow.setMap(null));
            currentInfowindows = [];

            const turbineName = name;
            const totalTurbines = turbineCountByComplex[name] || 0;
            const formattedCapacity = formatNumberWithCommas(capacity);

            const a = capacity;
            const b = totalTurbines;
            const totalComplexCapacity = a * b;
            const formattedTotalComplexCapacity = formatNumberWithCommas(totalComplexCapacity);

            const content = `
                <div class="detail-window" onclick="window.closeInfowindow(event, this)">
                    <strong>${turbineName}</strong><br>
                    ${translations[currentLanguage].manufacturer}: ${manufacturer || translations[currentLanguage].noInfo}<br>
                    ${translations[currentLanguage].singleCapacity}: ${formattedCapacity}<br>
                    ${translations[currentLanguage].totalTurbines}: ${totalTurbines}<br>
                    ${translations[currentLanguage].totalCapacity}: ${formattedTotalComplexCapacity}<br>
                    ${translations[currentLanguage].completionDate}: ${completionDate || translations[currentLanguage].noInfo}<br>
                    ${translations[currentLanguage].address}: ${address || translations[currentLanguage].noInfo}<br>                    
                </div>
            `;

            const basePosition = new kakao.maps.LatLng(lat, lon);
            const adjustedPosition = new kakao.maps.LatLng(lat - 0.005, lon);
            const infowindow = new kakao.maps.InfoWindow({
                position: adjustedPosition,
                content: content,
                zIndex: 20,
                removable: true
            });

            infowindow.open(map);
            currentInfowindows.push(infowindow);
        };

        window.closeInfowindow = function(event, element) {
            event.stopPropagation();
            const infowindowToClose = currentInfowindows.find(infowindow => 
                infowindow.getContent().includes(element.innerHTML)
            );
            if (infowindowToClose) {
                infowindowToClose.setMap(null);
                currentInfowindows = currentInfowindows.filter(iw => iw !== infowindowToClose);
                console.log("Info window closed");
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            kakao.maps.load(() => {
                console.log("Kakao Maps API loaded successfully");
                loadCSVData();
            });
        });

        window.addEventListener('unload', () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                console.log("Location tracking stopped");
            }
        });
    </script>
</body>
</html>
