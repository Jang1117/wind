<!DOCTYPE html>
<html>
<head>
    <title id="page-title">한국 풍력 발전소 지도</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9b8113591f35c3409335bdb4b5ee5613&libraries=clusterer&autoload=false" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            position: relative;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
        }
        #error-message {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .control-button {
            position: absolute;
            right: 10px;
            z-index: 10;
            padding: 8px 12px;
            width: 120px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            box-sizing: border-box;
            height: 34px;
            line-height: 1.5;
        }
        #map-type-toggle { top: 10px; }
        #name-toggle-button { top: 45px; }
        #reset-button { top: 80px; }
        #translate-button { top: 115px; }
        #windfarm-dropdown { top: 150px; }
        #manufacturer-dropdown { top: 185px; }
        #all-info, #manufacturer-info, #complex-info {
            position: absolute;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            text-align: center;
            display: none;
            max-width: 90%;
        }
        @media screen and (min-width: 768px) {
            #all-info, #manufacturer-info, #complex-info {
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
            }
        }
        @media screen and (max-width: 767px) {
            #all-info, #manufacturer-info, #complex-info {
                top: 10px;
                left: 10px;
                transform: none;
                text-align: left;
                max-width: 80%;
            }
        }
        .info-window {
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border: 1px solid #ccc;
            font-size: 12px;
            pointer-events: auto;
        }
        .detail-window {
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            white-space: nowrap;
            max-width: 90vw;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 80vh;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">지도 로딩 중...</div>
    <div id="error-message"></div>
    <button id="map-type-toggle" class="control-button">기본 지도</button>
    <button id="name-toggle-button" class="control-button">이름 끄기</button>
    <button id="reset-button" class="control-button">초기화</button>
    <button id="translate-button" class="control-button">English</button>
    <select id="windfarm-dropdown" class="control-button">
        <option value="">풍력단지</option>
    </select>
    <select id="manufacturer-dropdown" class="control-button">
        <option value="">제조사</option>
    </select>
    <div id="all-info">
        <span id="info-all-capacity"></span><br>
        <span id="info-all-capacity-gw"></span><br>
        <span id="info-all-complex-count"></span><br>
        <span id="info-all-turbine-count"></span>
    </div>
    <div id="manufacturer-info">
        <span id="info-manufacturer"></span><br>
        <span id="info-total-capacity"></span><br>
        <span id="info-complex-count"></span><br>
        <span id="info-turbine-count"></span>
    </div>
    <div id="complex-info">
        <span id="info-complex-name"></span><br>
        <span id="info-complex-capacity"></span><br>
        <span id="info-complex-capacity-breakdown"></span><br>
        <span id="info-complex-manufacturers"></span><br>
        <span id="info-complex-turbine-count"></span><br>
        <span id="info-complex-completion"></span>
    </div>

    <script>
        let map;
        let markers = [];
        let overlays = [];
        let currentInfowindows = [];
        let allWindFarms = [];
        let isSatellite = true;
        let turbineCountByComplex = {};
        let totalCapacityByComplex = {};
        let myLocationMarker = null;
        let watchId = null;
        let areNamesVisible = true;
        let selectedManufacturer = '';
        let selectedComplex = '';

        // 신규: 언어 상태 및 번역 데이터 변수
        let isEnglish = false;
        let translations = {};

        // 신규: 번역 JSON 파일 로드
        async function loadTranslations() {
            // translations.json 파일을 서버에서 가져옴
            try {
                const response = await fetch('translations.json');
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status}`);
                }
                translations = await response.json();
                console.log("번역 데이터 로드 성공:", translations);
                // 초기 UI 언어 설정
                updateUILanguage();
            } catch (error) {
                console.error("번역 데이터 로드 실패:", error);
                showError("번역 데이터를 로드할 수 없습니다.");
            }
        }

        // 신규: UI 언어 업데이트
        function updateUILanguage() {
            // 현재 언어 선택 (ko 또는 en)
            const lang = isEnglish ? 'en' : 'ko';
            // 페이지 제목 업데이트
            document.getElementById('page-title').textContent = translations[lang].title;
            // 로딩 메시지 업데이트
            document.getElementById('loading').textContent = translations[lang].loading;
            // 지도 유형 버튼 텍스트 업데이트
            document.getElementById('map-type-toggle').textContent = isSatellite ? translations[lang].mapTypeToggle : translations[lang].mapTypeToggleSatellite;
            // 이름 표시 버튼 텍스트 업데이트
            document.getElementById('name-toggle-button').textContent = areNamesVisible ? translations[lang].nameToggle : translations[lang].nameToggleOn;
            // 초기화 버튼 텍스트 업데이트
            document.getElementById('reset-button').textContent = translations[lang].reset;
            // 번역 버튼 텍스트 업데이트
            document.getElementById('translate-button').textContent = translations[lang].translate;
            // 풍력단지 드롭다운 기본 옵션 텍스트 업데이트
            document.getElementById('windfarm-dropdown').options[0].textContent = translations[lang].windfarmDropdown;
            // 제조사 드롭다운 기본 옵션 텍스트 업데이트
            document.getElementById('manufacturer-dropdown').options[0].textContent = translations[lang].manufacturerDropdown;
            // 정보 패널 업데이트
            updateInfoPanels();
            // 마커 및 오버레이 업데이트
            updateMarkers();
        }

        // 신규: 정보 패널 언어 업데이트
        function updateInfoPanels() {
            // 현재 언어 선택
            const lang = isEnglish ? 'en' : 'ko';
            // 전체 정보 패널이 표시 중일 때
            if (allWindFarms.length > 0 && document.getElementById('all-info').style.display === 'block') {
                const totalCapacity = allWindFarms.reduce((sum, farm) => sum + (farm.capacity || 0), 0);
                const complexCount = [...new Set(allWindFarms.map(farm => farm.complexId))].length;
                const turbineCount = allWindFarms.length;
                // 총 용량 업데이트
                document.getElementById('info-all-capacity').innerHTML = translations[lang].allInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
                // GW 단위 용량 업데이트
                document.getElementById('info-all-capacity-gw').innerHTML = translations[lang].allInfo.totalCapacityGW.replace('{{value}}', formatGW(totalCapacity));
                // 단지 수 업데이트
                document.getElementById('info-all-complex-count').innerHTML = translations[lang].allInfo.complexCount.replace('{{value}}', complexCount);
                // 터빈 수 업데이트
                document.getElementById('info-all-turbine-count').innerHTML = translations[lang].allInfo.turbineCount.replace('{{value}}', turbineCount);
            }
            // 제조사 정보 패널이 표시 중일 때
            if (selectedManufacturer && document.getElementById('manufacturer-info').style.display === 'block') {
                const filteredFarms = allWindFarms.filter(farm => farm.manufacturer === selectedManufacturer);
                const totalCapacity = filteredFarms.reduce((sum, farm) => sum + (farm.capacity || 0), 0);
                const complexCount = [...new Set(filteredFarms.map(farm => farm.complexId))].length;
                const turbineCount = filteredFarms.length;
                // 제조사 이름 업데이트
                document.getElementById('info-manufacturer').innerHTML = translations[lang].manufacturerInfo.manufacturer.replace('{{value}}', selectedManufacturer);
                // 총 용량 업데이트
                document.getElementById('info-total-capacity').innerHTML = translations[lang].manufacturerInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
                // 단지 수 업데이트
                document.getElementById('info-complex-count').innerHTML = translations[lang].manufacturerInfo.complexCount.replace('{{value}}', complexCount);
                // 터빈 수 업데이트
                document.getElementById('info-turbine-count').innerHTML = translations[lang].manufacturerInfo.turbineCount.replace('{{value}}', turbineCount);
            }
            // 단지 정보 패널이 표시 중일 때
            if (selectedComplex && document.getElementById('complex-info').style.display === 'block') {
                const farmsInComplex = allWindFarms.filter(farm => farm.complexId === selectedComplex);
                updateComplexInfo(farmsInComplex);
            }
        }

        // 신규: 에러 메시지 표시
        function showError(message) {
            // 에러 메시지 표시를 위한 div 가져오기
            const errorDiv = document.getElementById('error-message');
            // 메시지 설정
            errorDiv.innerText = message;
            // 표시
            errorDiv.style.display = 'block';
            // 5초 후 숨김
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 신규: 언어 토글 함수
        function toggleLanguage() {
            // 언어 상태 전환
            isEnglish = !isEnglish;
            console.log("언어 전환:", isEnglish ? "영어" : "한국어");
            // UI 업데이트
            updateUILanguage();
        }

        function formatNumberWithCommas(number) {
            if (!number) return translations[isEnglish ? 'en' : 'ko'].noInfo || "정보 없음";
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function formatGW(kw) {
            if (!kw) return translations[isEnglish ? 'en' : 'ko'].noInfo || "정보 없음";
            return (kw / 1000000).toFixed(2);
        }

        async function loadCSVData() {
            try {
                const response = await fetch('windfarm_data.csv');
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status} - ${response.statusText}`);
                }
                const text = await response.text();
                console.log("CSV 데이터:", text);

                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        allWindFarms = results.data.map(row => {
                            const name = row['단지명'] ? row['단지명'].trim() : null;
                            if (!name) return null;
                            return {
                                complexId: row['단지번호'] ? row['단지번호'].trim() : null,
                                name: name,
                                turbineId: row['풍력기번호(임시)'] ? row['풍력기번호(임시)'].trim() : null,
                                completionDate: row['준공일'] ? row['준공일'].trim() : null,
                                type: row['분류'] ? row['분류'].trim() : null,
                                address: row['주소'] ? row['주소'].trim() : null,
                                xCoord: row['엑스좌표(GRS80_C_x)'] ? parseFloat(row['엑스좌표(GRS80_C_x)']) : null,
                                yCoord: row['와이좌표(GRS80_C_y)'] ? parseFloat(row['와이좌표(GRS80_C_y)']) : null,
                                lat: row['위도(lat)'] ? parseFloat(row['위도(lat)']) : null,
                                lon: row['경도(lon)'] ? parseFloat(row['경도(lon)']) : null,
                                capacity: row['용량(kW)'] ? parseFloat(row['용량(kW)']) : null,
                                manufacturer: row['제조사'] ? row['제조사'].trim() : null
                            };
                        }).filter(row => row !== null);
                        console.log("파싱된 데이터:", allWindFarms);

                        turbineCountByComplex = {};
                        totalCapacityByComplex = {};
                        allWindFarms.forEach(farm => {
                            if (!turbineCountByComplex[farm.complexId]) {
                                turbineCountByComplex[farm.complexId] = 0;
                                totalCapacityByComplex[farm.complexId] = 0;
                            }
                            turbineCountByComplex[farm.complexId]++;
                            if (farm.capacity) {
                                totalCapacityByComplex[farm.complexId] += farm.capacity;
                            }
                        });
                        console.log("단지별 터빈 수:", turbineCountByComplex);
                        console.log("단지별 총 용량:", totalCapacityByComplex);

                        initMap();
                        populateDropdown();
                        populateManufacturerDropdown();
                    },
                    error: function(error) {
                        console.error('CSV 파싱 실패:', error);
                        showError(translations[isEnglish ? 'en' : 'ko'].errorMessage.csvParse.replace('{{message}}', error.message));
                    }
                });
            } catch (error) {
                console.error('CSV 로드 실패:', error);
                showError(translations[isEnglish ? 'en' : 'ko'].errorMessage.csvLoad.replace('{{message}}', error.message));
            }
        }

        function initMap() {
            console.log("initMap 호출됨");
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(35.68466926, 127.724382),
                level: 13
            };
            map = new kakao.maps.Map(container, options);
            map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
            console.log("지도 생성됨:", map);

            setTimeout(() => {
                map.relayout();
                if (allWindFarms.length > 0) {
                    const avgLat = allWindFarms.reduce((sum, farm) => sum + farm.lat, 0) / allWindFarms.length;
                    const avgLon = allWindFarms.reduce((sum, farm) => sum + farm.lon, 0) / allWindFarms.length;
                    map.setCenter(new kakao.maps.LatLng(avgLat, avgLon));

                    updateInfoPanels();
                    document.getElementById('all-info').style.display = 'block';
                }
                console.log("지도 렌더링 완료");
                updateMarkers();
                startTrackingLocation();
            }, 100);

            kakao.maps.event.addListener(map, 'click', () => {
                currentInfowindows.forEach(infowindow => infowindow.setMap(null));
                currentInfowindows = [];
            });

            kakao.maps.event.addListener(map, 'zoom_changed', updateMarkers);
            kakao.maps.event.addListener(map, 'idle', updateMarkers);

            document.getElementById('loading').style.display = 'none';

            document.getElementById('map-type-toggle').addEventListener('click', toggleMapType);
            document.getElementById('name-toggle-button').addEventListener('click', toggleNamesVisibility);
            document.getElementById('reset-button').addEventListener('click', resetSelections);
            document.getElementById('windfarm-dropdown').addEventListener('change', handleDropdownChange);
            document.getElementById('manufacturer-dropdown').addEventListener('change', handleManufacturerChange);
            // 신규: 번역 버튼 이벤트 리스너 추가
            document.getElementById('translate-button').addEventListener('click', toggleLanguage);
        }

        function toggleMapType() {
            if (isSatellite) {
                map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
                document.getElementById('map-type-toggle').textContent = translations[isEnglish ? 'en' : 'ko'].mapTypeToggleSatellite;
                isSatellite = false;
            } else {
                map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
                document.getElementById('map-type-toggle').textContent = translations[isEnglish ? 'en' : 'ko'].mapTypeToggle;
                isSatellite = true;
            }
            console.log("지도 유형 변경:", isSatellite ? "위성" : "기본");
        }

        function toggleNamesVisibility() {
            areNamesVisible = !areNamesVisible;
            document.getElementById('name-toggle-button').textContent = areNamesVisible ? translations[isEnglish ? 'en' : 'ko'].nameToggle : translations[isEnglish ? 'en' : 'ko'].nameToggleOn;
            updateMarkers();
        }

        function resetSelections() {
            selectedComplex = '';
            selectedManufacturer = '';
            document.getElementById('windfarm-dropdown').value = '';
            document.getElementById('manufacturer-dropdown').value = '';

            const allInfo = document.getElementById('all-info');
            const manufacturerInfo = document.getElementById('manufacturer-info');
            const complexInfo = document.getElementById('complex-info');
            allInfo.style.display = 'block';
            manufacturerInfo.style.display = 'none';
            complexInfo.style.display = 'none';

            setTimeout(() => {
                if (allWindFarms.length > 0) {
                    const avgLat = allWindFarms.reduce((sum, farm) => sum + farm.lat, 0) / allWindFarms.length;
                    const avgLon = allWindFarms.reduce((sum, farm) => sum + farm.lon, 0) / allWindFarms.length;
                    map.setCenter(new kakao.maps.LatLng(avgLat, avgLon));
                } else {
                    map.setCenter(new kakao.maps.LatLng(37.5, 127.5));
                }
                map.setLevel(13);
                map.relayout();
                updateMarkers();
                updateInfoPanels();
            }, 50);
        }

        function populateDropdown() {
            const dropdown = document.getElementById('windfarm-dropdown');
            const uniqueComplexes = [...new Set(allWindFarms.map(farm => farm.complexId))].filter(id => id);
            const complexNames = uniqueComplexes.map(id => {
                const farm = allWindFarms.find(f => f.complexId === id);
                return { id: id, name: farm.name };
            }).sort((a, b) => a.name.localeCompare(b.name, 'ko'));

            complexNames.forEach(complex => {
                const option = document.createElement('option');
                option.value = complex.id;
                option.textContent = complex.name;
                dropdown.appendChild(option);
            });
        }

        function populateManufacturerDropdown() {
            const dropdown = document.getElementById('manufacturer-dropdown');
            const uniqueManufacturers = [...new Set(allWindFarms.map(farm => farm.manufacturer))].filter(m => m).sort((a, b) => a.localeCompare(b, 'ko'));

            uniqueManufacturers.forEach(manufacturer => {
                const option = document.createElement('option');
                option.value = manufacturer;
                option.textContent = manufacturer;
                dropdown.appendChild(option);
            });
        }

        function handleDropdownChange(event) {
            selectedComplex = event.target.value;
            selectedManufacturer = '';
            document.getElementById('manufacturer-dropdown').value = '';

            const allInfo = document.getElementById('all-info');
            const manufacturerInfo = document.getElementById('manufacturer-info');
            const complexInfo = document.getElementById('complex-info');
            allInfo.style.display = 'none';
            manufacturerInfo.style.display = 'none';

            if (selectedComplex) {
                const farmsInComplex = allWindFarms.filter(farm => farm.complexId === selectedComplex);
                const avgLat = farmsInComplex.reduce((sum, farm) => sum + farm.lat, 0) / farmsInComplex.length;
                const avgLon = farmsInComplex.reduce((sum, farm) => sum + farm.lon, 0) / farmsInComplex.length;

                updateComplexInfo(farmsInComplex);
                complexInfo.style.display = 'block';

                map.setCenter(new kakao.maps.LatLng(avgLat, avgLon));
                map.setLevel(6);
            } else {
                complexInfo.style.display = 'none';
                allInfo.style.display = 'block';
                updateInfoPanels();
                map.setCenter(new kakao.maps.LatLng(35.68466926, 127.724382));
                map.setLevel(13);
            }

            updateMarkers();
        }

        function handleManufacturerChange(event) {
            selectedManufacturer = event.target.value;
            selectedComplex = '';
            document.getElementById('windfarm-dropdown').value = '';

            const allInfo = document.getElementById('all-info');
            const manufacturerInfo = document.getElementById('manufacturer-info');
            const complexInfo = document.getElementById('complex-info');
            allInfo.style.display = 'none';
            complexInfo.style.display = 'none';

            let filteredFarms = allWindFarms;
            if (selectedManufacturer) {
                filteredFarms = allWindFarms.filter(farm => farm.manufacturer === selectedManufacturer);
                const totalCapacity = filteredFarms.reduce((sum, farm) => sum + (farm.capacity || 0), 0);
                const complexCount = [...new Set(filteredFarms.map(farm => farm.complexId))].length;
                const turbineCount = filteredFarms.length;

                const lang = isEnglish ? 'en' : 'ko';
                document.getElementById('info-manufacturer').innerHTML = translations[lang].manufacturerInfo.manufacturer.replace('{{value}}', selectedManufacturer);
                document.getElementById('info-total-capacity').innerHTML = translations[lang].manufacturerInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
                document.getElementById('info-complex-count').innerHTML = translations[lang].manufacturerInfo.complexCount.replace('{{value}}', complexCount);
                document.getElementById('info-turbine-count').innerHTML = translations[lang].manufacturerInfo.turbineCount.replace('{{value}}', turbineCount);

                manufacturerInfo.style.display = 'block';
            } else {
                manufacturerInfo.style.display = 'none';
                allInfo.style.display = 'block';
                updateInfoPanels();
            }

            if (filteredFarms.length === 0) {
                map.setCenter(new kakao.maps.LatLng(35.68466926, 127.724382));
                map.setLevel(13);
            } else if (filteredFarms.length === 1) {
                const farm = filteredFarms[0];
                map.setCenter(new kakao.maps.LatLng(farm.lat, farm.lon));
                map.setLevel(6);
            } else {
                const bounds = new kakao.maps.LatLngBounds();
                filteredFarms.forEach(farm => {
                    if (farm.lat && farm.lon) {
                        bounds.extend(new kakao.maps.LatLng(farm.lat, farm.lon));
                    }
                });
                map.setBounds(bounds);
            }

            updateMarkers();
        }

        function updateComplexInfo(farmsInComplex) {
            const lang = isEnglish ? 'en' : 'ko';
            const complexName = farmsInComplex[0].name;
            const totalCapacity = farmsInComplex.reduce((sum, farm) => sum + (farm.capacity || 0), 0);
            const capacityCount = {};
            farmsInComplex.forEach(farm => {
                if (farm.capacity) {
                    capacityCount[farm.capacity] = (capacityCount[farm.capacity] || 0) + 1;
                }
            });
            const capacityBreakdown = Object.entries(capacityCount)
                .map(([cap, count]) => `${formatNumberWithCommas(cap)}kW * ${count}${isEnglish ? ' units' : '기'}`)
                .join(", ");
            const manufacturers = [...new Set(farmsInComplex.map(farm => farm.manufacturer).filter(m => m))].join(", ") || translations[lang].noInfo;
            const turbineCount = farmsInComplex.length;
            const completionDates = farmsInComplex.map(farm => farm.completionDate).filter(date => date);
            const completionDate = completionDates.length > 0 ? completionDates.sort()[0] : translations[lang].noInfo;

            document.getElementById('info-complex-name').innerHTML = translations[lang].complexInfo.name.replace('{{value}}', complexName);
            document.getElementById('info-complex-capacity').innerHTML = translations[lang].complexInfo.capacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
            document.getElementById('info-complex-capacity-breakdown').innerHTML = translations[lang].complexInfo.capacityBreakdown.replace('{{value}}', `(${capacityBreakdown})`);
            document.getElementById('info-complex-manufacturers').innerHTML = translations[lang].complexInfo.manufacturers.replace('{{value}}', manufacturers);
            document.getElementById('info-complex-turbine-count').innerHTML = translations[lang].complexInfo.turbineCount.replace('{{value}}', turbineCount);
            document.getElementById('info-complex-completion').innerHTML = translations[lang].complexInfo.completion.replace('{{value}}', completionDate);
        }

        function startTrackingLocation() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        console.log("내 위치 업데이트:", lat, lon);
                        updateMyLocation(lat, lon);
                    },
                    error => {
                        console.error("위치 가져오기 실패:", error);
                        showError(translations[isEnglish ? 'en' : 'ko'].errorMessage.geolocation);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                console.error("Geolocation 지원 안 됨");
                showError(translations[isEnglish ? 'en' : 'ko'].errorMessage.geolocationUnsupported);
            }
        }

        function updateMyLocation(lat, lon) {
            const position = new kakao.maps.LatLng(lat, lon);

            if (myLocationMarker) {
                myLocationMarker.setMap(null);
            }

            myLocationMarker = new kakao.maps.Marker({
                position: position,
                title: translations[isEnglish ? 'en' : 'ko'].myLocation || "내 위치",
                clickable: false,
                image: new kakao.maps.MarkerImage(
                    'me.png',
                    new kakao.maps.Size(48, 48)
                )
            });
            myLocationMarker.setMap(map);
            markers.push(myLocationMarker);
        }

        function clearMap() {
            markers.forEach(marker => marker.setMap(null));
            overlays.forEach(overlay => overlay.setMap(null));
            markers = [];
            overlays = [];
            currentInfowindows.forEach(infowindow => infowindow.setMap(null));
            currentInfowindows = [];
        }

        function updateMarkers() {
            clearMap();
            const zoomLevel = map.getLevel();
            console.log("현재 줌 레벨:", zoomLevel);

            const markerImage = new kakao.maps.MarkerImage(
                'wind.png',
                new kakao.maps.Size(48, 48),
                { offset: new kakao.maps.Point(16, 32) }
            );

            let filteredFarms = allWindFarms;
            if (selectedManufacturer) {
                filteredFarms = allWindFarms.filter(farm => farm.manufacturer === selectedManufacturer);
            } else if (selectedComplex) {
                filteredFarms = allWindFarms.filter(farm => farm.complexId === selectedComplex);
            }
            console.log("필터링된 터빈 수:", filteredFarms.length);

            const lang = isEnglish ? 'en' : 'ko';

            if (zoomLevel >= 10) {
              const farmsByComplex = {};
              filteredFarms.forEach(farm => {
                  if (!farmsByComplex[farm.complexId]) farmsByComplex[farm.complexId] = [];
                  farmsByComplex[farm.complexId].push(farm);
              });

              Object.keys(farmsByComplex).forEach(complexId => {
                  const group = farmsByComplex[complexId];
                  const avgLat = group.reduce((sum, farm) => sum + farm.lat, 0) / group.length;
                  const avgLon = group.reduce((sum, farm) => sum + farm.lon, 0) / group.length;
                  const position = new kakao.maps.LatLng(avgLat, avgLon);
                  const complexName = group[0].name;

                  const marker = new kakao.maps.Marker({
                      position: position,
                      title: `${complexName} (${group.length}${isEnglish ? ' turbines' : '개 터빈'})`,
                      clickable: true,
                      image: markerImage
                  });
                  marker.setMap(map);
                  markers.push(marker);

                  if (areNamesVisible) {
                      const overlay = new kakao.maps.CustomOverlay({
                          position: position,
                          content: `<div class="info-window">${translations[lang].infoWindow.replace('{{name}}', complexName).replace('{{count}}', group.length)}</div>`,
                          xAnchor: 0.5,
                          yAnchor: 2,
                          zIndex: 10
                      });
                      overlay.setMap(map);
                      overlays.push(overlay);
                  }

                  kakao.maps.event.addListener(marker, 'click', () => {
                      selectedComplex = complexId;
                      selectedManufacturer = '';
                      document.getElementById('manufacturer-dropdown').value = '';
                      document.getElementById('windfarm-dropdown').value = complexId;

                      const allInfo = document.getElementById('all-info');
                      const manufacturerInfo = document.getElementById('manufacturer-info');
                      const complexInfo = document.getElementById('complex-info');
                      allInfo.style.display = 'none';
                      manufacturerInfo.style.display = 'none';

                      updateComplexInfo(group);
                      complexInfo.style.display = 'block';

                      map.setCenter(position);
                      const currentLevel = map.getLevel();
                      map.setLevel(currentLevel - 5);
                      updateMarkers();
                  });
              });
            } else {
              const bounds = map.getBounds();
              const visibleFarms = filteredFarms.filter(farm =>
                  farm.lat && farm.lon && bounds.contain(new kakao.maps.LatLng(farm.lat, farm.lon))
              );
              console.log("표시될 터빈 수:", visibleFarms.length);

              visibleFarms.forEach(farm => {
                  const position = new kakao.maps.LatLng(farm.lat, farm.lon);
                  const turbineName = `${farm.name} ${farm.turbineId}`;
                  const marker = new kakao.maps.Marker({
                      position: position,
                      title: turbineName,
                      clickable: true,
                      image: markerImage
                  });
                  marker.setMap(map);
                  markers.push(marker);

                  if (areNamesVisible) {
                      const overlay = new kakao.maps.CustomOverlay({
                          position: position,
                          content: `<div class="info-window" onclick="toggleFarmDetails('${farm.name}', '${farm.turbineId}', '${farm.type}', '${farm.completionDate}', '${farm.address}', ${farm.lat}, ${farm.lon}, '${farm.capacity}', '${farm.manufacturer}', '${farm.complexId}')">${turbineName}</div>`,
                          xAnchor: 0.5,
                          yAnchor: 2,
                          zIndex: 10
                      });
                      overlay.setMap(map);
                      overlays.push(overlay);
                  }

                  kakao.maps.event.addListener(marker, 'click', () => toggleFarmDetails(farm.name, farm.turbineId, farm.type, farm.completionDate, farm.address, farm.lat, farm.lon, farm.capacity, farm.manufacturer, farm.complexId));
              });
            }

            if (myLocationMarker) {
                myLocationMarker.setMap(map);
                markers.push(myLocationMarker);
            }
        }

        window.toggleFarmDetails = function(name, turbineId, type, completionDate, address, lat, lon, capacity, manufacturer, complexId) {
            currentInfowindows.forEach(infowindow => infowindow.setMap(null));
            currentInfowindows = [];

            const lang = isEnglish ? 'en' : 'ko';
            const turbineName = name;
            const totalTurbines = turbineCountByComplex[complexId] || 0;
            const formattedCapacity = formatNumberWithCommas(capacity);
            const totalComplexCapacity = totalCapacityByComplex[complexId] || 0;
            const formattedTotalComplexCapacity = formatNumberWithCommas(totalComplexCapacity);

            const farmsInComplex = allWindFarms.filter(farm => farm.complexId === complexId);
            const capacityCount = {};
            farmsInComplex.forEach(farm => {
                if (farm.capacity) {
                    capacityCount[farm.capacity] = (capacityCount[farm.capacity] || 0) + 1;
                }
            });

            const truncateText = (text, maxLength) => {
                if (!text || text === translations[lang].noInfo) return text || translations[lang].noInfo;
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            };

            const capacityBreakdown = Object.entries(capacityCount)
                .map(([cap, count]) => `${formatNumberWithCommas(cap)}kW * ${count}${isEnglish ? ' units' : '기'}`)
                .join(", ");

            const content = `
                <div class="detail-window" onclick="window.closeInfowindow(event, this)">
                    ${translations[lang].detailWindow.name.replace('{{value}}', truncateText(turbineName, 20))}<br>
                    ${translations[lang].detailWindow.manufacturer.replace('{{value}}', truncateText(manufacturer || translations[lang].noInfo, 15))}<br>
                    ${translations[lang].detailWindow.capacity.replace('{{value}}', formattedCapacity)}<br>
                    ${translations[lang].detailWindow.turbineCount.replace('{{value}}', totalTurbines)}<br>
                    ${translations[lang].detailWindow.complexCapacity.replace('{{value}}', truncateText(formattedTotalComplexCapacity, 25))}<br>
                    ${translations[lang].detailWindow.capacityBreakdown.replace('{{value}}', truncateText(capacityBreakdown, 25))}<br>
                    ${translations[lang].detailWindow.completion.replace('{{value}}', truncateText(completionDate || translations[lang].noInfo, 15))}<br>
                    ${translations[lang].detailWindow.address.replace('{{value}}', truncateText(address || translations[lang].noInfo, 20))}<br>
                </div>
            `;

            console.log("toggleFarmDetails 호출됨:", { name, lat, lon, zoomLevel: map.getLevel() });

            const basePosition = new kakao.maps.LatLng(lat, lon);
            const zoomLevel = map.getLevel();
            let offsetLat = 0.0005;
            const adjustedPosition = new kakao.maps.LatLng(lat - offsetLat, lon);

            console.log("정보 창 위치:", { lat: lat - offsetLat, lon, offsetLat });

            const infowindow = new kakao.maps.InfoWindow({
                position: adjustedPosition,
                content: content,
                zIndex: 20,
                removable: true
            });

            try {
                infowindow.open(map);
                currentInfowindows.push(infowindow);
                console.log("정보 창 열림:", infowindow);
            } catch (error) {
                console.error("정보 창 열기 실패:", error);
            }
        };

        window.closeInfowindow = function(event, element) {
            event.stopPropagation();
            const infowindowToClose = currentInfowindows.find(infowindow =>
                infowindow.getContent().includes(element.innerHTML)
            );
            if (infowindowToClose) {
                infowindowToClose.setMap(null);
                currentInfowindows = currentInfowindows.filter(iw => iw !== infowindowToClose);
                console.log("정보 창 닫힘");
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            kakao.maps.load(() => {
                console.log("Kakao Maps API 로드 성공");
                // 신규: 번역 데이터 로드 후 CSV 데이터 로드
                loadTranslations().then(() => loadCSVData());
            });
        });

        window.addEventListener('unload', () => {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                console.log("위치 추적 중지");
            }
        });
    </script>
</body>
</html>
