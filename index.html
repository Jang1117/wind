<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>국내 풍력 발전소 지도</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        #map {
            flex: 1;
            width: 100%;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #333;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        select, button {
            padding: 8px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        button:hover, select:hover {
            background-color: #f0f0f0;
        }
        .info-panel {
            position: absolute;
            top: 60px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            max-width: 300px;
            font-size: 14px;
            display: none;
        }
        .info-panel p {
            margin: 5px 0;
        }
        .error-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }
        .detail-window {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-size: 12px;
            max-width: 250px;
            z-index: 20;
        }
        .custom-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 15;
        }
        @media (max-width: 600px) {
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            select, button {
                width: 100%;
                max-width: 200px;
            }
            .info-panel {
                top: 180px;
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="loading">로딩 중...</div>
    <div class="error-message" id="error-message"></div>
    <div class="controls">
        <select id="windfarm-dropdown">
            <option value="">모든 단지</option>
        </select>
        <select id="manufacturer-dropdown">
            <option value="">모든 제조사</option>
        </select>
        <select id="operator-dropdown">
            <option value="">모든 사업자</option>
        </select>
        <select id="complex-age-dropdown">
            <option value="">모든 단지 연령</option>
        </select>
        <button id="map-type-toggle">위성 지도</button>
        <button id="name-toggle-button">이름 켜기</button>
        <button id="marker-toggle-button">마커 끄기</button>
        <button id="translate-button">English</button>
        <button id="info-button">정보</button>
        <button id="reset-button">필터 초기화</button>
        <button id="settings-button">설정</button>
        <button id="initial-reset">초기화</button>
    </div>
    <div class="info-panel" id="all-info">
        <p id="info-total-capacity"></p>
        <p id="info-complex-count"></p>
        <p id="info-turbine-count"></p>
        <p id="info-manufacturer-count"></p>
        <p id="info-operator-count"></p>
    </div>
    <div class="info-panel" id="manufacturer-info">
        <p id="info-manufacturer"></p>
        <p id="info-manufacturer-capacity"></p>
        <p id="info-manufacturer-complex-count"></p>
        <p id="info-manufacturer-turbine-count"></p>
    </div>
    <div class="info-panel" id="complex-info">
        <p id="info-complex"></p>
        <p id="info-complex-capacity"></p>
        <p id="info-complex-turbine-count"></p>
        <p id="info-complex-address"></p>
        <p id="info-complex-operator"></p>
    </div>
    <div class="info-panel" id="operator-info">
        <p id="info-operator"></p>
        <p id="info-operator-capacity"></p>
        <p id="info-operator-complex-count"></p>
        <p id="info-operator-turbine-count"></p>
    </div>
    <div class="info-panel" id="complex-age-info">
        <p id="info-complex-age"></p>
        <p id="info-complex-age-capacity"></p>
        <p id="info-complex-age-complex-count"></p>
        <p id="info-complex-age-turbine-count"></p>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=ae8b110ae9c8f8b3d21ce2f5b6b6bb7f"></script>
    <script>
        // 전역 변수 초기화
        let map;
        let markers = [];
        let overlays = [];
        let currentInfowindows = [];
        let allWindFarms = [];
        let isSatellite = true;
        let turbineCountByComplex = {};
        let totalCapacityByComplex = {};
        let myLocationMarker = null;
        let watchId = null;
        let areNamesVisible = false; // 단지 이름 기본값: 꺼짐
        let areMarkersVisible = true;
        let selectedManufacturer = '';
        let selectedComplex = '';
        let selectedOperator = '';
        let selectedComplexAge = '';
        let isEnglish = false;
        let translations = {
            ko: {
                title: "국내 풍력 발전소 지도",
                loading: "로딩 중...",
                mapTypeToggle: "위성 지도",
                mapTypeToggleSatellite: "일반 지도",
                nameToggle: "이름 끄기",
                nameToggleOn: "이름 켜기",
                markerToggle: "마커 끄기",
                markerToggleOn: "마커 켜기",
                translate: "English",
                translateEn: "한국어",
                infoButton: "정보",
                reset: "필터 초기화",
                settings: "설정",
                initialReset: "초기화",
                windfarmDropdown: "모든 단지",
                manufacturerDropdown: "모든 제조사",
                operatorDropdown: "모든 사업자",
                complexAgeDropdown: "모든 단지 연령",
                allInfo: {
                    totalCapacity: "총 용량: {{value}} kW",
                    complexCount: "단지 수: {{count}}",
                    turbineCount: "터빈 수: {{count}}",
                    manufacturerCount: "제조사 수: {{count}}",
                    operatorCount: "사업자 수: {{count}}"
                },
                manufacturerInfo: {
                    manufacturer: "제조사: {{value}}",
                    totalCapacity: "총 용량: {{value}} kW",
                    complexCount: "단지 수: {{count}}",
                    turbineCount: "터빈 수: {{count}}"
                },
                farmInfo: {
                    complex: "단지: {{value}}",
                    totalCapacity: "총 용량: {{value}} kW",
                    turbineCount: "터빈 수: {{count}}",
                    address: "주소: {{value}}",
                    operator: "사업자: {{value}}"
                },
                operatorInfo: {
                    operator: "사업자: {{value}}",
                    totalCapacity: "총 용량: {{value}} kW",
                    complexCount: "단지 수: {{count}}",
                    turbineCount: "터빈 수: {{count}}"
                },
                complexAgeInfo: {
                    complexAge: "단지 연령: {{value}}년",
                    totalCapacity: "총 용량: {{value}} kW",
                    complexCount: "단지 수: {{count}}",
                    turbineCount: "터빈 수: {{count}}"
                },
                detailWindow: {
                    name: "이름: {{value}}",
                    manufacturer: "제조사: {{value}}",
                    capacity: "용량: {{value}} kW",
                    turbineCount: "터빈 수: {{value}}",
                    complexCapacity: "단지 용량: {{value}} kW",
                    capacityBreakdown: "용량 분포: {{value}}",
                    completion: "단지 연령: {{value}}년",
                    address: "주소: {{value}}",
                    operator: "사업자: {{value}}"
                },
                errorMessage: {
                    dataLoad: "데이터 로드 실패: {{message}}",
                    translationsLoad: "번역 데이터 로드 실패: {{message}}",
                    geolocation: "위치 정보 획득 실패: {{message}}"
                },
                noInfo: "정보 없음"
            },
            en: {
                title: "South Korea Wind Farm Map",
                loading: "Loading...",
                mapTypeToggle: "Satellite Map",
                mapTypeToggleSatellite: "Standard Map",
                nameToggle: "Hide Names",
                nameToggleOn: "Show Names",
                markerToggle: "Hide Markers",
                markerToggleOn: "Show Markers",
                translate: "한국어",
                translateEn: "English",
                infoButton: "Info",
                reset: "Reset Filters",
                settings: "Settings",
                initialReset: "Initialize",
                windfarmDropdown: "All Complexes",
                manufacturerDropdown: "All Manufacturers",
                operatorDropdown: "All Operators",
                complexAgeDropdown: "All Complex Ages",
                allInfo: {
                    totalCapacity: "Total Capacity: {{value}} kW",
                    complexCount: "Complex Count: {{count}}",
                    turbineCount: "Turbine Count: {{count}}",
                    manufacturerCount: "Manufacturer Count: {{count}}",
                    operatorCount: "Operator Count: {{count}}"
                },
                manufacturerInfo: {
                    manufacturer: "Manufacturer: {{value}}",
                    totalCapacity: "Total Capacity: {{value}} kW",
                    complexCount: "Complex Count: {{count}}",
                    turbineCount: "Turbine Count: {{count}}"
                },
                farmInfo: {
                    complex: "Complex: {{value}}",
                    totalCapacity: "Total Capacity: {{value}} kW",
                    turbineCount: "Turbine Count: {{count}}",
                    address: "Address: {{value}}",
                    operator: "Operator: {{value}}"
                },
                operatorInfo: {
                    operator: "Operator: {{value}}",
                    totalCapacity: "Total Capacity: {{value}} kW",
                    complexCount: "Complex Count: {{count}}",
                    turbineCount: "Turbine Count: {{count}}"
                },
                complexAgeInfo: {
                    complexAge: "Complex Age: {{value}} years",
                    totalCapacity: "Total Capacity: {{value}} kW",
                    complexCount: "Complex Count: {{count}}",
                    turbineCount: "Turbine Count: {{count}}"
                },
                detailWindow: {
                    name: "Name: {{value}}",
                    manufacturer: "Manufacturer: {{value}}",
                    capacity: "Capacity: {{value}} kW",
                    turbineCount: "Turbine Count: {{value}}",
                    complexCapacity: "Complex Capacity: {{value}} kW",
                    capacityBreakdown: "Capacity Breakdown: {{value}}",
                    completion: "Complex Age: {{value}} years",
                    address: "Address: {{value}}",
                    operator: "Operator: {{value}}"
                },
                errorMessage: {
                    dataLoad: "Failed to load data: {{message}}",
                    translationsLoad: "Failed to load translations: {{message}}",
                    geolocation: "Failed to get location: {{message}}"
                },
                noInfo: "No Information"
            }
        };
        let siteTranslations = [];
        let manufacturerData = null;

        // 번역된 단지 이름 가져오기
        function getTranslatedName(complexId) {
            const translation = siteTranslations.find(t => t.site_number === parseInt(complexId));
            if (!translation) return `단지_${complexId}`;
            return isEnglish ? translation.site_name_roman : translation.site_name_kr;
        }

        // 번역된 주소 가져오기
        function getTranslatedAddress(complexId) {
            const translation = siteTranslations.find(t => t.site_number === parseInt(complexId));
            if (!translation || !translation.address_kr) return translations[isEnglish ? 'en' : 'ko'].noInfo;
            return isEnglish ? translation.address_roman : translation.address_kr;
        }

        // 번역된 사업자 이름 가져오기
        function getTranslatedOperator(operator) {
            if (!operator) return translations[isEnglish ? 'en' : 'ko'].noInfo;
            if (isEnglish) {
                const translation = siteTranslations.find(t => t.operator_kr === operator);
                return translation ? translation.operator_en : operator;
            }
            return operator;
        }

        // 단지 연령 계산
        function getComplexAge(completionDate) {
            if (!completionDate || isNaN(parseInt(completionDate))) return null;
            const currentYear = 2025; // 현재 연도
            const completionYear = parseInt(completionDate);
            return currentYear - completionYear;
        }

        // 숫자 포맷팅 함수
        function formatNumberWithCommas(number) {
            if (number == null) return translations[isEnglish ? 'en' : 'ko'].noInfo;
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // 에러 메시지 표시
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 번역 데이터 로드
        async function loadTranslations() {
            try {
                console.log("translations.json 요청 중: /wind/translations.json");
                const response = await fetch('/wind/translations.json?t=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status} - ${response.statusText}`);
                }
                siteTranslations = await response.json();
                console.log("번역 데이터 로드 성공:", siteTranslations);
            } catch (error) {
                console.error("번역 데이터 로드 실패:", error);
                showError(translations[isEnglish ? 'en' : 'ko'].errorMessage.translationsLoad.replace('{{message}}', error.message));
                siteTranslations = [];
            }
        }

        // CSV 데이터 로드
        async function loadCSVData() {
            document.getElementById('loading').style.display = 'block';
            try {
                console.log("CSV 요청 중: /wind/windfarm_data.csv");
                const response = await fetch('/wind/windfarm_data.csv?t=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP 오류! 상태: ${response.status} - ${response.statusText}`);
                }
                const text = await response.text();
                console.log("CSV 데이터 수신 완료, 파싱 시작");
                allWindFarms = parseCSV(text);
                console.log("파싱된 풍력 발전소 데이터:", allWindFarms.length);
                calculateComplexStats();
                populateDropdown();
                populateManufacturerDropdown();
                populateOperatorDropdown();
                populateComplexAgeDropdown();
                updateInfoPanels();
                updateMarkers();
            } catch (error) {
                console.error("CSV 데이터 로드 실패:", error);
                showError(translations[isEnglish ? 'en' : 'ko'].errorMessage.dataLoad.replace('{{message}}', error.message));
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // CSV 파싱 함수
        function parseCSV(text) {
            const lines = text.trim().split('\n').slice(1); // 헤더 제거
            const farms = [];
            lines.forEach((line, index) => {
                try {
                    const cols = line.split(',').map(col => col.trim());
                    if (cols.length < 11) {
                        console.warn(`행 ${index + 2}에서 열 수가 부족합니다:`, cols);
                        return;
                    }
                    const farm = {
                        turbineId: cols[0],
                        type: cols[1],
                        completionDate: cols[2],
                        address: cols[3],
                        lat: parseFloat(cols[4]),
                        lon: parseFloat(cols[5]),
                        capacity: parseFloat(cols[6]) || 0,
                        manufacturer: cols[7],
                        complexId: cols[8],
                        operator: cols[9],
                        complexName: cols[10] || `단지_${cols[8]}`
                    };
                    farms.push(farm);
                } catch (e) {
                    console.warn(`행 ${index + 2} 파싱 오류:`, e);
                }
            });
            return farms;
        }

        // 단지별 통계 계산
        function calculateComplexStats() {
            turbineCountByComplex = {};
            totalCapacityByComplex = {};
            allWindFarms.forEach(farm => {
                if (!turbineCountByComplex[farm.complexId]) {
                    turbineCountByComplex[farm.complexId] = 0;
                    totalCapacityByComplex[farm.complexId] = 0;
                }
                turbineCountByComplex[farm.complexId]++;
                totalCapacityByComplex[farm.complexId] += farm.capacity;
            });
        }

        // 단지 드롭다운 채우기
        function populateDropdown() {
            const dropdown = document.getElementById('windfarm-dropdown');
            dropdown.innerHTML = `<option value="">${translations[isEnglish ? 'en' : 'ko'].windfarmDropdown}</option>`;
            const complexes = [...new Set(allWindFarms.map(farm => farm.complexId))].sort((a, b) => a - b);
            complexes.forEach(complexId => {
                const option = document.createElement('option');
                option.value = complexId;
                option.textContent = getTranslatedName(complexId);
                dropdown.appendChild(option);
            });
        }

        // 제조사 드롭다운 채우기
        function populateManufacturerDropdown() {
            const dropdown = document.getElementById('manufacturer-dropdown');
            dropdown.innerHTML = `<option value="">${translations[isEnglish ? 'en' : 'ko'].manufacturerDropdown}</option>`;
            const manufacturers = [...new Set(allWindFarms.map(farm => farm.manufacturer).filter(m => m))].sort();
            manufacturers.forEach(manufacturer => {
                const option = document.createElement('option');
                option.value = manufacturer;
                option.textContent = manufacturer;
                dropdown.appendChild(option);
            });
        }

        // 사업자 드롭다운 채우기
        function populateOperatorDropdown() {
            const dropdown = document.getElementById('operator-dropdown');
            dropdown.innerHTML = `<option value="">${translations[isEnglish ? 'en' : 'ko'].operatorDropdown}</option>`;
            const operators = [...new Set(allWindFarms.map(farm => farm.operator).filter(o => o))].sort();
            operators.forEach(operator => {
                const option = document.createElement('option');
                option.value = operator;
                option.textContent = getTranslatedOperator(operator);
                dropdown.appendChild(option);
            });
        }

        // 단지 연령 드롭다운 채우기
        function populateComplexAgeDropdown() {
            const dropdown = document.getElementById('complex-age-dropdown');
            dropdown.innerHTML = `<option value="">${translations[isEnglish ? 'en' : 'ko'].complexAgeDropdown}</option>`;
            const ages = allWindFarms
                .map(farm => getComplexAge(farm.completionDate))
                .filter(age => age !== null);
            const uniqueAges = [...new Set(ages)].sort((a, b) => a - b);
            const ageRanges = [];
            for (let i = 0; i <= Math.max(...uniqueAges); i += 5) {
                ageRanges.push(`${i}-${i + 4}`);
            }
            ageRanges.forEach(range => {
                const option = document.createElement('option');
                option.value = range;
                option.textContent = `${range}${isEnglish ? ' years' : '년'}`;
                dropdown.appendChild(option);
            });
        }

        // 정보 패널 업데이트
        function updateInfoPanels() {
            const filteredFarms = getFilteredFarms();
            updateAllInfoPanel(filteredFarms);
            updateManufacturerInfoPanel(filteredFarms);
            updateComplexInfoPanel(filteredFarms);
            updateOperatorInfoPanel(filteredFarms);
            updateComplexAgeInfoPanel(filteredFarms);
        }

        // 전체 정보 패널
        function updateAllInfoPanel(farms) {
            const totalCapacity = farms.reduce((sum, farm) => sum + farm.capacity, 0);
            const complexCount = [...new Set(farms.map(f => f.complexId))].length;
            const turbineCount = farms.length;
            const manufacturerCount = [...new Set(farms.map(f => f.manufacturer).filter(m => m))].length;
            const operatorCount = [...new Set(farms.map(f => f.operator).filter(o => o))].length;

            document.getElementById('info-total-capacity').textContent = translations[isEnglish ? 'en' : 'ko'].allInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
            document.getElementById('info-complex-count').textContent = translations[isEnglish ? 'en' : 'ko'].allInfo.complexCount.replace('{{count}}', complexCount);
            document.getElementById('info-turbine-count').textContent = translations[isEnglish ? 'en' : 'ko'].allInfo.turbineCount.replace('{{count}}', turbineCount);
            document.getElementById('info-manufacturer-count').textContent = translations[isEnglish ? 'en' : 'ko'].allInfo.manufacturerCount.replace('{{count}}', manufacturerCount);
            document.getElementById('info-operator-count').textContent = translations[isEnglish ? 'en' : 'ko'].allInfo.operatorCount.replace('{{count}}', operatorCount);
        }

        // 제조사 정보 패널
        function updateManufacturerInfoPanel(farms) {
            if (!selectedManufacturer) {
                document.getElementById('manufacturer-info').style.display = 'none';
                return;
            }
            const filtered = farms.filter(f => f.manufacturer === selectedManufacturer);
            const totalCapacity = filtered.reduce((sum, f) => sum + f.capacity, 0);
            const complexCount = [...new Set(filtered.map(f => f.complexId))].length;
            const turbineCount = filtered.length;

            document.getElementById('info-manufacturer').textContent = translations[isEnglish ? 'en' : 'ko'].manufacturerInfo.manufacturer.replace('{{value}}', selectedManufacturer);
            document.getElementById('info-manufacturer-capacity').textContent = translations[isEnglish ? 'en' : 'ko'].manufacturerInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
            document.getElementById('info-manufacturer-complex-count').textContent = translations[isEnglish ? 'en' : 'ko'].manufacturerInfo.complexCount.replace('{{count}}', complexCount);
            document.getElementById('info-manufacturer-turbine-count').textContent = translations[isEnglish ? 'en' : 'ko'].manufacturerInfo.turbineCount.replace('{{count}}', turbineCount);
            document.getElementById('manufacturer-info').style.display = 'block';
        }

        // 단지 정보 패널
        function updateComplexInfoPanel(farms) {
            if (!selectedComplex) {
                document.getElementById('complex-info').style.display = 'none';
                return;
            }
            const filtered = farms.filter(f => f.complexId === selectedComplex);
            const totalCapacity = filtered.reduce((sum, f) => sum + f.capacity, 0);
            const turbineCount = filtered.length;
            const address = getTranslatedAddress(parseInt(selectedComplex));
            const operator = filtered[0]?.operator ? getTranslatedOperator(filtered[0].operator) : translations[isEnglish ? 'en' : 'ko'].noInfo;

            document.getElementById('info-complex').textContent = translations[isEnglish ? 'en' : 'ko'].farmInfo.complex.replace('{{value}}', getTranslatedName(selectedComplex));
            document.getElementById('info-complex-capacity').textContent = translations[isEnglish ? 'en' : 'ko'].farmInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
            document.getElementById('info-complex-turbine-count').textContent = translations[isEnglish ? 'en' : 'ko'].farmInfo.turbineCount.replace('{{count}}', turbineCount);
            document.getElementById('info-complex-address').textContent = translations[isEnglish ? 'en' : 'ko'].farmInfo.address.replace('{{value}}', address);
            document.getElementById('info-complex-operator').textContent = translations[isEnglish ? 'en' : 'ko'].farmInfo.operator.replace('{{value}}', operator);
            document.getElementById('complex-info').style.display = 'block';
        }

        // 사업자 정보 패널
        function updateOperatorInfoPanel(farms) {
            if (!selectedOperator) {
                document.getElementById('operator-info').style.display = 'none';
                return;
            }
            const filtered = farms.filter(f => f.operator === selectedOperator);
            const totalCapacity = filtered.reduce((sum, f) => sum + f.capacity, 0);
            const complexCount = [...new Set(filtered.map(f => f.complexId))].length;
            const turbineCount = filtered.length;

            document.getElementById('info-operator').textContent = translations[isEnglish ? 'en' : 'ko'].operatorInfo.operator.replace('{{value}}', getTranslatedOperator(selectedOperator));
            document.getElementById('info-operator-capacity').textContent = translations[isEnglish ? 'en' : 'ko'].operatorInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
            document.getElementById('info-operator-complex-count').textContent = translations[isEnglish ? 'en' : 'ko'].operatorInfo.complexCount.replace('{{count}}', complexCount);
            document.getElementById('info-operator-turbine-count').textContent = translations[isEnglish ? 'en' : 'ko'].operatorInfo.turbineCount.replace('{{count}}', turbineCount);
            document.getElementById('operator-info').style.display = 'block';
        }

        // 단지 연령 정보 패널
        function updateComplexAgeInfoPanel(farms) {
            if (!selectedComplexAge) {
                document.getElementById('complex-age-info').style.display = 'none';
                return;
            }
            const [minAge, maxAge] = selectedComplexAge.split('-').map(Number);
            const filtered = farms.filter(f => {
                const age = getComplexAge(f.completionDate);
                return age !== null && age >= minAge && age <= maxAge;
            });
            const totalCapacity = filtered.reduce((sum, f) => sum + f.capacity, 0);
            const complexCount = [...new Set(filtered.map(f => f.complexId))].length;
            const turbineCount = filtered.length;

            document.getElementById('info-complex-age').textContent = translations[isEnglish ? 'en' : 'ko'].complexAgeInfo.complexAge.replace('{{value}}', selectedComplexAge);
            document.getElementById('info-complex-age-capacity').textContent = translations[isEnglish ? 'en' : 'ko'].complexAgeInfo.totalCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacity));
            document.getElementById('info-complex-age-complex-count').textContent = translations[isEnglish ? 'en' : 'ko'].complexAgeInfo.complexCount.replace('{{count}}', complexCount);
            document.getElementById('info-complex-age-turbine-count').textContent = translations[isEnglish ? 'en' : 'ko'].complexAgeInfo.turbineCount.replace('{{count}}', turbineCount);
            document.getElementById('complex-age-info').style.display = 'block';
        }

        // 필터링된 데이터 가져오기
        function getFilteredFarms() {
            return allWindFarms.filter(farm => {
                const matchesComplex = !selectedComplex || farm.complexId === selectedComplex;
                const matchesManufacturer = !selectedManufacturer || farm.manufacturer === selectedManufacturer;
                const matchesOperator = !selectedOperator || farm.operator === selectedOperator;
                const matchesAge = !selectedComplexAge || (() => {
                    const age = getComplexAge(farm.completionDate);
                    if (age === null) return false;
                    const [minAge, maxAge] = selectedComplexAge.split('-').map(Number);
                    return age >= minAge && age <= maxAge;
                })();
                return matchesComplex && matchesManufacturer && matchesOperator && matchesAge;
            });
        }

        // 마커 업데이트
        function updateMarkers() {
            clearMarkers();
            const filteredFarms = getFilteredFarms();
            const complexPositions = {};

            filteredFarms.forEach(farm => {
                if (!complexPositions[farm.complexId]) {
                    complexPositions[farm.complexId] = [];
                }
                complexPositions[farm.complexId].push(farm);
            });

            Object.keys(complexPositions).forEach(complexId => {
                const farms = complexPositions[complexId];
                const avgLat = farms.reduce((sum, f) => sum + f.lat, 0) / farms.length;
                const avgLon = farms.reduce((sum, f) => sum + f.lon, 0) / farms.length;

                if (!isNaN(avgLat) && !isNaN(avgLon)) {
                    const markerPosition = new kakao.maps.LatLng(avgLat, avgLon);
                    const marker = new kakao.maps.Marker({
                        map: areMarkersVisible ? map : null,
                        position: markerPosition
                    });

                    const infowindow = new kakao.maps.InfoWindow({
                        content: createDetailWindow(farms),
                        removable: true
                    });

                    kakao.maps.event.addListener(marker, 'click', function() {
                        currentInfowindows.forEach(w => w.close());
                        infowindow.open(map, marker);
                        currentInfowindows.push(infowindow);
                    });

                    markers.push(marker);

                    if (areNamesVisible) {
                        const overlay = new kakaoOverlay({
                            content: `<div class="custom-overlay">${getTranslatedName(complexId)}</div>`,
                            position: markerPosition,
                            yAnchor: -0.5,
                            map: map
                        });
                        overlays.push(overlay);
                    });
                });
                    }
                });

            if (myLocationMarker) {
                myLocationMarker.setMap(areMarkersVisible ? map : null);
            }
        }

        // 상세 정보 창 생성
        function createDetailWindow(farms) {
            const complexId = farms[0].complexId;
            const totalCapacity = farms.reduce((sum, f) => sum + f.capacity, 0);
            const turbineCount = farms.length;
            const capacities = farms.map(f => f.capacity).filter(c => c > 0);
            const capacityBreakdown = capacities.length > 0 ? 
                [...new Set(capacities)].map(c => `${c} kW x ${capacities.filter(x => x === c).length}`).join(', ') : 
                translations[isEnglish ? 'en' : 'ko'].noInfo;
            const completionAge = getComplexAge(farms[0].completionDate) || '0';
            const address = getTranslatedAddress(parseInt(complexId));
            const operator = farms[0]?.operator ? getTranslatedOperator(farms[0].operator) : translations[isEnglish ? 'en' : 'ko'].noInfo;

            return `
                <div class="detail-window">
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.name.replace('{{value}}', getTranslatedName(complexId))}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.manufacturer.replace('{{value}}', farms[0].manufacturer || 'N/A')}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.capacity.replace('{{value}}', formatNumberWithCommas(totalCapacity))}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.turbineCount.replace('{{value}}', turbineCount)}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.complexCapacity.replace('{{value}}', formatNumberWithCommas(totalCapacityByComplex[complexId]))}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.capacityBreakdown.replace('{{value}}', capacityBreakdown)}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.completion.replace('{{value}}', completionAge)}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.address.replace('{{value}}', address)}</p>
                    <p>${translations[isEnglish ? 'en' : 'ko'].detailWindow.operator.replace('{{value}}', operator)}</p>
                </div>
            `;
        }

        // 마커 및 오버레이 제거
        function clearMarkers() {
            markers.forEach(m => m.setMap(null)));
            overlays.forEach(o => o.setMap(null)));
            currentInfowindows.forEach(w => w.close());
            markers = [];
            overlays = [];
            currentInfowindows = [];
        }

        // 지도 초기화
        function initializeMap() {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(36.5, 127.5,  // 한국 중심
                level: 13,
                mapTypeId: kakao.maps.MapTypeId.HYBRID
            });

            map = new kakao.Map(mapContainer, mapOption);
        }

        // 지도 타입 토글
        document.getElementById('map-type-toggle').addEventListener('click', () => {
            isSatellite = !isSatellite;
            map.setMapTypeId(isSatellite ? kakao.maps.MapTypeId.HYBRID : kakao.MapTypeId.ROADMAP);
            document.getElementById('map-type-toggle').textContent = translations[isSatellite ? 'en' : 'ko'].mapTypeToggleSatellite;
        });

        // 이름 토글
        document.getElementById('name-toggle-button').addEventListener('click', () => {
            areNamesVisible = !areNamesVisible;
            document.getElementById('name-toggle-button').textContent = translations[isEnglish ? 'en' : 'ko'][areNamesVisible ? 'nameToggle' : 'nameToggleOn'];
            updateMarkers();
        });

        // 마커 토글
        document.getElementById('marker-toggle-button').addEventListener('click', () => {
            areMarkersVisible = !areMarkersVisible;
            document.getElementById('marker-toggle-button').textContent = translations[isEnglish ? 'en' : 'ko'][areMarkersVisible ? 'markerToggle' : 'markerToggleOn'];
            markers.forEach(m => m.setMap(areMarkersVisible ? map : null));
            if (myLocationMarker) {
                myLocationMarker.setMap(areMarkersVisible ? map : null);
            }
        });

        // 언어 전환
        document.getElementById('translate-button').addEventListener('click', () => {
            isEnglish = !isEnglish;
            document.getElementById('translate-button').textContent = translations[isEnglish ? 'en' : 'ko'].translate;
            document.title = translations[isEnglish ? 'en' : 'ko'].title;
            populateDropdown();
            populateManufacturerDropdown();
            populateOperatorDropdown();
            populateComplexAgeDropdown();
            updateInfoPanels();
            updateMarkers();
            document.getElementById('map-type-toggle').textContent = translations[isEnglish ? 'en' : 'ko'][isSatellite ? 'mapTypeToggleSatellite' : 'mapTypeToggle'];
            document.getElementById('name-toggle-button').textContent = translations[isEnglish ? 'en' : 'ko'][areNamesVisible ? 'nameToggle' : 'nameToggleOn'];
            document.getElementById('marker-toggle-button').textContent = translations[isEnglish ? 'en' : 'ko'][areMarkersVisible ? 'markerToggle' : 'markerToggleOn'];
            document.getElementById('info-button').textContent = translations[isEnglish ? 'en' : 'ko'].infoButton;
            document.getElementById('reset-button').textContent = translations[isEnglish ? 'en' : 'ko'].reset;
            document.getElementById('settings-button').textContent = translations[isEnglish ? 'en' : 'ko'].settings';
            document.getElementById('initial-reset').textContent = translations[isEnglish ? 'en' : 'ko'].initialReset';
        });

        // 정보 패널 토글
        document.getElementById('info-button').addEventListener('click', () => {
            const allInfo = document.getElementById('all-info');
            allInfo.style.display = allInfo.style.display === 'none' ? 'block' : 'none';
        });

        // 필터 초기화
        document.getElementById('reset-button').addEventListener('click', () => {
            selectedManufacturer = '';
            selectedComplex = '';
            selectedOperator = '';
            selectedComplexAge = '';
            document.getElementById('windfarm-dropdown').value = '';
            document.getElementById('manufacturer-dropdown').value = '';
            document.getElementById('operator-dropdown').value = '';
            document.getElementById('complex-age-dropdown').value = '';
            updateInfoPanels();
            updateMarkers();
        });

        // 설정 (미구현)
        document.getElementById('settings-button').addEventListener('click', () => {
            alert('Settings functionality not implemented.');
        });

        // 초기화 (지도 중심 복원)
        document.getElementById('initial-reset').addEventListener('click', () => {
            map.setCenter('new kakao.maps.LatLng(36.5, 127.5));
            map.setLevel(13);
            selectedManufacturer = '';
            selectedComplex = '';
            selectedOperator = '';
            selectedComplexAge = '';
            document.getElementById('windfarm-dropdown').value = '';
            document.getElementById('manufacturer-dropdown').value = '';
            document.getElementById('operator-dropdown').value = '';
            document.getElementById('complex-age-dropdown').value = '';
            updateInfoPanels();
            updateMarkers();
        });

        // 드롭다운 이벤트
        document.getElementById('windfarm-dropdown').addEventListener('change', e => {
            selectedComplex = e.target.value;
            updateInfoPanels();
            updateMarkers();
        });

        document.getElementById('manufacturer-dropdown').addEventListener('change', e => {
            selectedManufacturer = e.target.value;
            updateInfoPanels();
            updateMarkers();
        });

        document.getElementById('operator-dropdown').addEventListener('change', e => {
            selectedOperator = e.target.value;
            updateInfoPanels();
            updateMarkers();
        });

        document.getElementById('complex-age-dropdown').addEventListener('change', e => {
            selectedComplexAge = e.target.value;
            updateInfoPanels();
            updateMarkers();
        });

        // 초기화 함수
        async function init() {
            initializeMap();
            await loadTranslations();
            await loadCSVData();
        }

        init();
    </script>
</body>
</html>
